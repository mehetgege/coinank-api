<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Trading Command Center - Unified</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>
    <style>
        :root {
            --ticker-height: 32px;
            --signal-bar-height: 40px;
            --header-min-height: 48px;
            --panel-bg: #0d1117;
            --input-bg: #010409;
            --hover-bg: #161b22;
            --border-color: #30363d;
            --text-main: #c9d1d9;
            --text-secondary: #8b949e;
            --primary: #58a6ff;
            --positive: #238636;
            --negative: #da3633;
            --neutral: #ffc107;
            --metatron-color: #58a6ff;
            --uriel-color: #f778ba;
            --raphael-color: #3fb950;
        }

        [data-theme="light"] {
            --panel-bg: #ffffff;
            --input-bg: #f6f8fa;
            --hover-bg: #f3f4f6;
            --border-color: #d0d7de;
            --text-main: #1f2328;
            --text-secondary: #57606a;
            --primary: #0969da;
            --positive: #1a7f37;
            --negative: #cf222e;
        }
        
        [data-theme="war"] {
            --panel-bg: #1b1302;
            --input-bg: #0f0a02;
            --hover-bg: #2a1d04;
            --border-color: #3c2a07;
            --text-main: #f8ecd3;
            --text-secondary: #e5c98f;
            --primary: #ffc107;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--input-bg);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
            padding-top: calc(var(--ticker-height) + var(--signal-bar-height));
        }

        /* Super Top Ticker */
        #super-top-ticker {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--ticker-height);
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 1100;
            font-family: 'Roboto Mono', monospace; font-size: 12px;
        }
        .super-top-left { display: flex; gap: 10px; }
        #ticker-bar-price { font-weight: 700; }
        .super-top-right-buttons { display: flex; gap: 5px; }
        .mobile-only { display: none; }

        /* Signal Progress Bar */
        #signal-progress-bar-container {
            display: flex; gap: 5px; width: 100%; padding: 5px 10px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            justify-content: space-around; align-items: center;
            position: fixed; top: var(--ticker-height); left: 0; z-index: 1099;
            height: var(--signal-bar-height);
        }
        .signal-bar-wrapper { flex: 1; text-align: center; }
        .signal-bar-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 3px; text-transform: uppercase; }
        .signal-bar { width: 100%; height: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; position: relative; }
        .signal-bar-fill { height: 100%; width: 0%; transition: width 0.2s ease-out; position: absolute; left: 0; top: 0; }
        .signal-bar-fill.buy { background: linear-gradient(90deg, transparent, var(--metatron-color)); }
        .signal-bar-fill.sell { background: linear-gradient(90deg, transparent, var(--uriel-color)); }
        .signal-score-text { font-size: 9px; margin-top: 2px; color: var(--primary); font-family: 'Roboto Mono', monospace; }

        /* Header */
        .header {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin: 5px;
            flex-shrink: 0;
        }
        .header-top-bar {
            display: flex; align-items: center; justify-content: center;
            padding: 0 10px;
            min-height: var(--header-min-height);
            cursor: pointer;
            user-select: none;
        }
        .header-center-title { font-weight: 700; font-size: 14px; color: var(--primary); }
        .header-collapsible-content {
            padding: 10px;
            border-top: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        }
        body.header-collapsed .header-collapsible-content { max-height: 0; padding-top: 0; padding-bottom: 0; border-top: none; }
        .main-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-items: center; }
        .form-control, .btn, .status { width: 100%; text-align: center; padding: 6px 10px; font-size: 12px; }
        .form-control { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Roboto Mono', monospace; }
        .status { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--negative); transition: background-color 0.5s; }
        .status-dot.online { background: var(--positive); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 #28a745b3; } 70% { box-shadow: 0 0 0 6px #28a74500; } 100% { box-shadow: 0 0 0 0 #28a74500; } }
        .btn { padding: 6px 12px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-main); border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .btn:hover { background: var(--hover-bg); border-color: var(--primary); }
        .btn-success { background: var(--positive); color: white; border-color: var(--positive); }
        .btn-danger { background: var(--negative); color: white; border-color: var(--negative); }
        .btn-tiny { padding: 2px 6px; font-size: 10px; line-height: 1; }
        .price-display { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; width: 100%; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; font-size: 10px; }
        .price-item .price-label { color: var(--text-secondary); }
        .price-item .price-value { font-size: 18px; font-weight: 700; }
        .price-item.countdown { grid-column: 1 / span 2; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: 700; color: var(--primary); padding-top: 5px; }

        /* Main Grid & Panels */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 5px; flex-grow: 1; margin: 0 5px 5px 5px; overflow: hidden; }
        .panel { display: flex; flex-direction: column; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; position: relative; }
        .panel-title { font-weight: 700; font-size: 13px; color: var(--primary); padding: 8px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .center-panel { padding: 0 !important; }
        .data-container { display: grid; grid-template-rows: 2fr 1fr; overflow: hidden; height: 100%; }
        .data-grid { position: relative; overflow: hidden; min-height: 0; }
        #live-chart { width: 100%; height: 100%; }
        .heatmap-container { display: grid; grid-template-rows: auto 1fr; border-top: 1px solid var(--border-color); }
        #orderbook-heatmap { width: 100%; height: 100%; display: block; }
        .chart-zoom-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
        .chart-zoom-controls .btn-tiny { background: rgba(1, 4, 9, 0.7); backdrop-filter: blur(2px); }
        #exit-fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 101; background: rgba(1, 4, 9, 0.7); color: white; border-radius: 4px; padding: 2px 6px; font-size: 16px; cursor: pointer; border: 1px solid var(--border-color); line-height: 1; display: none; }
        #chart-countdown-overlay { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(1, 4, 9, 0.7); padding: 4px 8px; border-radius: 4px; color: var(--primary); font-size: 14px; font-weight: bold; display: none; }
        .resize-handle { position: absolute; bottom: 0; left: 0; width: 100%; height: 8px; cursor: ns-resize; z-index: 10; border-top: 3px solid var(--border-color); }
        .center-panel.resizing { user-select: none; }

        /* Notifications */
        .notifications { position: fixed; bottom: 15px; left: 15px; z-index: 2000; width: 320px; }
        .notification { background: rgba(22, 27, 34, 0.9); backdrop-filter: blur(4px); border: 1px solid var(--border-color); border-left-width: 4px; border-radius: 4px; padding: 8px 12px; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); margin-top: 8px; animation: slide-in 0.3s ease-out; }
        @keyframes slide-in { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { border-left-color: var(--positive); }
        .notification.danger { border-left-color: var(--negative); }
        .notification.warning { border-left-color: var(--neutral); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2500; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 900px; max-height: 90%; display: flex; flex-direction: column; box-shadow: 0 8px 30px rgba(0,0,0,0.4); transform: translateY(20px); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: translateY(0); }
        .modal-header { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 15px; color: var(--primary); }
        .modal-header .close-btn { background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; padding: 0 5px; line-height: 1; }
        .modal-body { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        #settings-modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-group { margin-bottom: 15px; }
        .form-group { margin-bottom: 8px; }
        .form-label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; padding: 4px 0; }
        .data-table-container { width: 100%; max-height: 300px; overflow: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .data-table th, .data-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table th { font-weight: 700; position: sticky; top: 0; background: var(--panel-bg); z-index: 10; }
        .data-table tr:hover { background: var(--hover-bg); }
        .signal-buy { background-color: #28a74514; } .signal-sell { background-color: #dc354514; }
        .signal-tp { background-color: #28a74533; } .signal-sl { background-color: #dc354533; }
        .signal-pending { background-color: #ffc1071a; }
        #log-output { font-family: 'Roboto Mono', monospace; font-size: 11px; color: var(--text-secondary); padding: 10px; margin: 0; white-space: pre-wrap; word-break: break-all; }
        #log-output .log-error { color: var(--negative); }
        #log-output .log-warn { color: var(--neutral); }
        #log-output .log-info { color: var(--positive); }

        /* Panteon & Kehanet Panels */
        #panteon-panel, #kehanet-panel {
            position: fixed;
            z-index: 1200;
            background: rgba(22, 27, 34, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        #panteon-panel { top: calc(var(--ticker-height) + var(--signal-bar-height) + 5px); right: 5px; width: 220px; }
        .panteon-header { font-weight: 700; color: var(--primary); text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; margin-bottom: 2px; font-size: 12px; }
        .elci-display { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px; }
        .elci-name { font-weight: 700; }
        .elci-name.metatron { color: var(--metatron-color); }
        .elci-name.uriel { color: var(--uriel-color); }
        .elci-name.raphael { color: var(--raphael-color); }
        .elci-reputation { font-weight: 700; font-size: 12px; text-align: right; }
        .elci-mode { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 1px 4px; font-size: 9px; text-align: center; font-weight: 700; }
        .elci-mode.i_nançlı { color: var(--positive); border-color: var(--positive); }
        .elci-mode.şüpheci { color: var(--neutral); border-color: var(--neutral); }
        .elci-mode.kiyamet { color: var(--negative); border-color: var(--negative); animation: pulse-danger 1.5s infinite; }
        @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 #dc354580; } 70% { box-shadow: 0 0 0 5px #dc354500; } 100% { box-shadow: 0 0 0 0 #dc354500; } }
        #kehanet-panel { bottom: 15px; right: 15px; }
        #kehanet-panel .btn-tiny { font-size: 14px; }

        /* Effects & Misc */
        #effects-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .hidden-view { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 3px; }
        .user-select-none { user-select: none; -webkit-user-select: none; }

        /* Mobile Styles */
        @media screen and (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: flex !important; align-items: center; }
            #panteon-panel, #kehanet-panel { display: none; }
            .container { padding-top: calc(var(--ticker-height) + var(--signal-bar-height)); padding-bottom: var(--header-min-height); }
            .header { order: 2; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; z-index: 1000; margin: 0; border-radius: 0; border: none; border-top: 1px solid var(--border-color); }
            .header-top-bar { justify-content: space-between; }
            .header-center-title .header-title-text { display: none; }
            .header-collapsible-content { grid-template-columns: 1fr; }
            .main-controls { grid-template-columns: repeat(2, 1fr); }
            .main-grid { order: 1; margin: 0; height: 100%; display: flex; flex-direction: column; }
            .center-panel { order: 1; flex-grow: 1; height: 100%; border: none; border-radius: 0; background: transparent; box-shadow: none; margin: 0; }
            .center-panel > .panel-title { display: none; }
            .data-container { display: flex; flex-direction: column; height: 100%; padding: 5px; }
            .data-grid { height: 100%; flex-grow: 1; }
            .heatmap-container { height: 150px; flex-shrink: 0; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
            .resize-handle { display: none; }
            #settings-modal-body { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <canvas id="effects-canvas"></canvas>
    
    <div id="super-top-ticker">
        <div class="super-top-left">
            <span id="ticker-bar-symbol">BTC/USDT</span>
            <span id="ticker-bar-price">69,420.69</span>
        </div>
        <div class="super-top-right-buttons desktop-only">
            <button id="main-controls-btn" class="btn btn-tiny">Komuta</button>
            <button id="chart-view-btn" class="btn btn-tiny">Grafik</button>
            <button id="heatmap-view-btn" class="btn btn-tiny">Isı Haritası</button>
            <button id="fullscreen-chart-btn" class="btn btn-tiny">Tam Ekran</button>
            <button id="honor-board-btn" class="btn btn-tiny">Şeref Tablosu</button>
            <button id="banned-board-btn" class="btn btn-tiny">Zindan</button>
            <button id="open-settings-modal-btn" class="btn btn-tiny">Ayarlar</button>
        </div>
        <div class="super-top-right-buttons mobile-only">
            <button id="mobile-fullscreen-chart-btn" class="btn btn-tiny">Tam Ekran</button>
            <button id="mobile-open-log-modal-btn" class="btn btn-tiny">📜</button>
            <button id="mobile-open-settings-modal-btn" class="btn btn-tiny">⚙️</button>
        </div>
    </div>

    <div id="signal-progress-bar-container">
        <div class="signal-bar-wrapper">
            <div class="signal-bar-label">METATRON GÜVENİ</div>
            <div class="signal-bar"><div id="buy-signal-bar-fill" class="signal-bar-fill buy"></div></div>
            <div id="buy-signal-score-text" class="signal-score-text">0.0</div>
        </div>
        <div class="signal-bar-wrapper">
            <div class="signal-bar-label">URIEL CESARETİ</div>
            <div class="signal-bar"><div id="sell-signal-bar-fill" class="signal-bar-fill sell"></div></div>
            <div id="sell-signal-score-text" class="signal-score-text">0.0</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div id="header-main-bar" class="header-top-bar user-select-none">
                <div class="header-left-controls mobile-only">
                    <button id="mobile-toggle-controls-btn" class="btn btn-tiny">☰</button>
                </div>
                <div class="header-center-title">
                    <span class="header-title-text">KOMUTA MERKEZİ</span>
                </div>
                <div class="header-right-controls mobile-only">
                    <button id="mobile-chart-view-btn" class="btn btn-tiny">📈</button>
                    <button id="mobile-heatmap-view-btn" class="btn btn-tiny">🔥</button>
                </div>
            </div>
            <div class="header-collapsible-content">
                <div class="main-controls">
                    <input type="text" id="symbol-input" class="form-control" placeholder="Örn: BTCUSDT">
                    <select id="timeframe-select" class="form-control">
                        <option value="1m">1m</option><option value="5m">5m</option><option value="15m" selected>15m</option><option value="1h">1h</option><option value="4h">4h</option>
                    </select>
                    <div class="status">
                        <div id="connection-status" class="status-dot"></div>
                        <span id="connection-text">BAĞLANTI YOK</span>
                    </div>
                    <button id="theme-toggle-btn" class="btn">Tema</button>
                    <button id="start-btn" class="btn btn-success">SİSTEMİ BAŞLAT</button>
                    <button id="stop-btn" class="btn btn-danger" disabled>DURDUR</button>
                </div>
                <div class="price-display">
                    <div class="price-item"><div class="price-label">FİYAT</div><div class="price-value" id="current-price">-</div></div>
                    <div class="price-item"><div class="price-label">24s DEĞİŞİM</div><div class="price-value" id="price-change-24h">-</div></div>
                    <div class="price-item"><div class="price-label">24s HACİM</div><div class="price-value" id="volume-24h">-</div></div>
                    <div class="price-item"><div class="price-label">VOLATİLİTE (ATR)</div><div class="price-value" id="atr-value">-</div></div>
                    <div class="price-item countdown"><span id="candle-countdown">--:--</span></div>
                </div>
            </div>
        </header>

        <main class="main-grid">
            <section class="center-panel panel">
                <div class="data-container" id="data-container">
                    <div class="data-grid" id="chart-container-view">
                        <div id="live-chart"></div>
                        <div class="chart-zoom-controls"> 
                            <button id="chart-zoom-in" class="btn btn-tiny">+</button>
                            <button id="chart-zoom-out" class="btn btn-tiny">-</button>
                            <button id="chart-zoom-reset" class="btn btn-tiny">Sıfırla</button>
                        </div>
                        <button id="exit-fullscreen-btn" class="btn btn-tiny" title="Tam Ekrandan Çık">&times;</button>
                        <div id="chart-countdown-overlay">--:--</div>
                    </div>
                    <div class="heatmap-container hidden-view" id="heatmap-container-view">
                        <div class="panel-title user-select-none" style="border-top: 1px solid var(--border-color); border-bottom: none;">EMİR DEFTERİ ISI HARİTASI</div>
                        <canvas id="orderbook-heatmap"></canvas>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </section>
        </main>
    </div>
    
    <div id="notifications-container" class="notifications"></div>

    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>AMELİYATHANE & OPTİMİZASYON</span>
                <button class="close-btn" id="close-settings-modal-btn">&times;</button>
            </div>
            <div class="modal-body" id="settings-modal-body">
                </div>
            <div class="modal-footer">
                <button id="reset-all-settings-btn" class="btn btn-danger">EVRENİ SIFIRLA</button>
                <button id="save-settings-btn" class="btn btn-success">KADERİ MÜHÜRLE</button>
            </div>
        </div>
    </div>

    <div id="log-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>KAHİN'İN GÜNLÜĞÜ</span>
                <div>
                    <button id="export-logs-btn" class="btn btn-tiny btn-success">Dışa Aktar</button>
                    <button class="close-btn" id="close-log-modal-btn">&times;</button>
                </div>
            </div>
            <div class="modal-body"><pre id="log-output"></pre></div>
        </div>
    </div>

    <div id="honor-modal-overlay" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <div id="honor-modal-title" class="modal-title">Şeref Tablosu</div>
          <button id="close-honor-modal" class="close-btn">&times;</button>
        </div>
        <div id="honor-modal-body" class="modal-body"></div>
      </div>
    </div>

    <aside id="panteon-panel">
        <div class="panteon-header user-select-none">PANTEON'UN İRADESİ</div>
        <div class="elci-display">
            <span class="elci-name metatron">METATRON</span>
            <span class="elci-mode" id="metatron-mode">İNANÇLI</span>
            <span class="elci-reputation" id="metatron-rep">100</span>
        </div>
        <div class="elci-display">
            <span class="elci-name uriel">URIEL</span>
            <span class="elci-mode" id="uriel-mode">İNANÇLI</span>
            <span class="elci-reputation" id="uriel-rep">100</span>
        </div>
        <div class="elci-display">
            <span class="elci-name raphael">RAPHAEL</span>
            <span class="elci-mode" id="raphael-mode">İNANÇLI</span>
            <span class="elci-reputation" id="raphael-rep">100</span>
        </div>
    </aside>

    <aside id="kehanet-panel">
        <button id="prophecy-defensive" class="btn btn-tiny" title="Kehanet: Defansif">🛡️</button>
        <button id="prophecy-neutral" class="btn btn-tiny" title="Kehanet: Nötr">⚖️</button>
        <button id="prophecy-aggressive" class="btn btn-tiny" title="Kehanet: Agresif">⚔️</button>
    </aside>

<script>
//<![CDATA[
'use strict';

//================================================================================
// DATA PERSISTENCE & MIGRATION (From GPTE.HTML)
//================================================================================

class DBManager {
    constructor(dbName, version, upgradeCallback) {
        this.dbName = dbName;
        this.version = version;
        this.upgradeCallback = upgradeCallback;
        this.db = null;
    }

    async open() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onerror = (event) => reject("IndexedDB error: " + event.target.errorCode);
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve(this.db);
            };
            request.onupgradeneeded = (event) => {
                this.db = event.target.result;
                if (this.upgradeCallback) {
                    this.upgradeCallback(this.db, event.oldVersion, event.newVersion);
                }
            };
        });
    }

    async get(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(storeName, 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (event) => reject("Error getting data: " + event.target.errorCode);
        });
    }

    async getAll(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(storeName, 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = (event) => reject("Error getting all data: " + event.target.errorCode);
        });
    }

    async put(storeName, value, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = key ? store.put(value, key) : store.put(value);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (event) => reject("Error putting data: " + event.target.errorCode);
        });
    }
    
    async delete(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(key);
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject("Error deleting data: " + event.target.errorCode);
        });
    }

    async clear(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject("Error clearing store: " + event.target.errorCode);
        });
    }
}

class Migration {
    constructor(dbManager) {
        this.dbManager = dbManager;
    }

    async run() {
        await this.dbManager.open();
        console.log("Database opened for migration check.");
    }

    static upgrade(db, oldVersion, newVersion) {
        console.log(`Upgrading database from version ${oldVersion} to ${newVersion}`);
        if (oldVersion < 1) {
            db.createObjectStore('panteon', { keyPath: 'id' });
            db.createObjectStore('kehanet', { keyPath: 'id' });
            db.createObjectStore('app_state', { keyPath: 'id' });
        }
        if (oldVersion < 2) {
            if (!db.objectStoreNames.contains('history')) {
                 db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
            }
        }
        if (oldVersion < 3) {
             if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'id' });
            }
        }
    }
}

class StorageBridge {
    constructor(dbManager) {
        this.db = dbManager;
    }
    async getState(key, defaultValue = null) {
        const result = await this.db.get('app_state', key);
        return result ? result.value : defaultValue;
    }
    async setState(key, value) {
        await this.db.put('app_state', { id: key, value });
    }
    async getPanteon(key) {
        return await this.db.get('panteon', key);
    }
    async setPanteon(data) {
        await this.db.put('panteon', data);
    }
    async getKehanet(key) {
        return await this.db.get('kehanet', key);
    }
    async setKehanet(data) {
        await this.db.put('kehanet', data);
    }
    async getSettings(key, defaultValue = {}) {
        const result = await this.db.get('settings', key);
        return result ? result.value : defaultValue;
    }
    async saveSettings(key, value) {
        await this.db.put('settings', { id: key, value });
    }
    async getAllHistory() {
        return await this.db.getAll('history');
    }
    async addHistory(record) {
        await this.db.put('history', record);
    }
    async clearHistory() {
        await this.db.clear('history');
    }
}


//================================================================================
// VISUAL EFFECTS MANAGER (From GPTE.HTML)
//================================================================================

class EffectsManager {
    constructor(canvasId) {
        this.canvasEl = document.getElementById(canvasId);
        if (!this.canvasEl) {
            console.error("Effects canvas not found!");
            return;
        }
        this.init();
    }

    async init() {
        await tsParticles.load({
            id: "effects-canvas",
            options: {
                autoPlay: true,
                particles: {
                    number: { value: 0 },
                    color: { value: ["#58a6ff", "#f778ba", "#3fb950", "#ffc107"] },
                    shape: { type: "circle" },
                    opacity: { value: { min: 0.5, max: 1 }, animation: { enable: true, speed: 1, sync: false, destroy: 'min' } },
                    size: { value: { min: 2, max: 4 } },
                    links: { enable: false },
                    move: {
                        enable: true,
                        speed: 2,
                        direction: "none",
                        random: false,
                        straight: false,
                        outModes: { default: "destroy" },
                    },
                },
                interactivity: { enable: false },
                background: { color: "transparent" },
                emitters: [],
            },
        });
    }

    trigger(type) {
        let emitterOptions;
        const commonOptions = {
            life: { duration: 0.5, count: 1 },
            rate: { quantity: 50, delay: 0.05 },
        };

        switch (type) {
            case 'buy':
                emitterOptions = { ...commonOptions, position: { x: 25, y: 10 }, particles: { move: { angle: { value: 0, offset: 20 } }, color: { value: '#58a6ff' } } };
                break;
            case 'sell':
                emitterOptions = { ...commonOptions, position: { x: 75, y: 10 }, particles: { move: { angle: { value: 0, offset: 20 } }, color: { value: '#f778ba' } } };
                break;
            case 'divine':
                emitterOptions = {
                    ...commonOptions,
                    rate: { quantity: 100, delay: 0.01 },
                    position: { x: 50, y: 100 },
                    particles: { move: { direction: "top", speed: 4 }, color: { value: '#ffc107' } }
                };
                break;
            default:
                return;
        }
        
        const container = tsParticles.domItem(0);
        if (container) {
            container.addEmitter(emitterOptions);
        }
    }
}


//================================================================================
// PANTEON & KEHANET MANAGER (From GPTE.HTML)
//================================================================================

class PanteonManager {
    constructor(storage) {
        this.storage = storage;
        this.elciler = {};
        this.ui = {
            metatron: { mode: document.getElementById('metatron-mode'), rep: document.getElementById('metatron-rep') },
            uriel: { mode: document.getElementById('uriel-mode'), rep: document.getElementById('uriel-rep') },
            raphael: { mode: document.getElementById('raphael-mode'), rep: document.getElementById('raphael-rep') },
        };
    }

    async init() {
        const metatronData = await this.storage.getPanteon('metatron') || { id: 'metatron', reputation: 100, mode: 'İNANÇLI' };
        const urielData = await this.storage.getPanteon('uriel') || { id: 'uriel', reputation: 100, mode: 'İNANÇLI' };
        const raphaelData = await this.storage.getPanteon('raphael') || { id: 'raphael', reputation: 100, mode: 'İNANÇLI' };
        
        this.elciler = { metatron: metatronData, uriel: urielData, raphael: raphaelData };
        this.updateAllDisplays();
    }

    updateReputation(elciId, change) {
        if (!this.elciler[elciId]) return;
        
        this.elciler[elciId].reputation += change;
        if (this.elciler[elciId].reputation > 100) this.elciler[elciId].reputation = 100;
        if (this.elciler[elciId].reputation < 0) this.elciler[elciId].reputation = 0;
        
        this.updateMode(elciId);
        this.updateDisplay(elciId);
        this.save(elciId);
    }

    updateMode(elciId) {
        const rep = this.elciler[elciId].reputation;
        let newMode = 'İNANÇLI';
        if (rep < 70) newMode = 'ŞÜPHECİ';
        if (rep < 30) newMode = 'KIYAMET';
        this.elciler[elciId].mode = newMode;
    }

    updateDisplay(elciId) {
        if (!this.ui[elciId] || !this.elciler[elciId]) return;
        this.ui[elciId].rep.textContent = this.elciler[elciId].reputation;
        const modeEl = this.ui[elciId].mode;
        modeEl.textContent = this.elciler[elciId].mode;
        modeEl.className = 'elci-mode'; // Reset classes
        modeEl.classList.add(this.elciler[elciId].mode.toLowerCase());
    }

    updateAllDisplays() {
        for (const elciId in this.elciler) {
            this.updateDisplay(elciId);
        }
    }

    async save(elciId) {
        await this.storage.setPanteon(this.elciler[elciId]);
    }
}


//================================================================================
// MAIN APPLICATION CLASS (From fulf.html, with integrations)
//================================================================================

class UltimateTradingCommandCenter {
    constructor(storage) {
        this.storage = storage;
        this.isSystemRunning = false;
        this.websocket = null;
        this.chart = null;
        this.candleSeries = null;
        this.heatmapCanvas = document.getElementById('orderbook-heatmap');
        this.heatmapCtx = this.heatmapCanvas.getContext('2d');
        this.currentSymbol = 'BTCUSDT';
        this.currentTimeframe = '15m';
        this.candleCountdownInterval = null;
        this.lastCandleCloseTime = 0;
        this.isResizing = false;
        this.isChartFullscreen = false;
        this.settings = {};
        this.defaultSettings = {
            'general': { 'theme': 'dark', 'autoStart': false },
            'chart': { 'showCountdown': true, 'showATR': true },
            'notifications': { 'tradeSignals': true, 'systemStatus': true }
        };

        // Integrated Managers
        this.effectsManager = new EffectsManager('effects-canvas');
        this.panteonManager = window.panteonManager; // From global scope
        
        this.bindUI();
        this.loadSettings();
        this.initChart();
        this.initResizeHandle();
    }

    bindUI() {
        this.ui = {
            symbolInput: document.getElementById('symbol-input'),
            timeframeSelect: document.getElementById('timeframe-select'),
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            connectionStatus: document.getElementById('connection-status'),
            connectionText: document.getElementById('connection-text'),
            currentPrice: document.getElementById('current-price'),
            priceChange24h: document.getElementById('price-change-24h'),
            volume24h: document.getElementById('volume-24h'),
            atrValue: document.getElementById('atr-value'),
            candleCountdown: document.getElementById('candle-countdown'),
            chartCountdownOverlay: document.getElementById('chart-countdown-overlay'),
            notificationsContainer: document.getElementById('notifications-container'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            headerMainBar: document.getElementById('header-main-bar'),
            // Modals
            openSettingsBtn: document.getElementById('open-settings-modal-btn'),
            mobileOpenSettingsBtn: document.getElementById('mobile-open-settings-modal-btn'),
            settingsModal: document.getElementById('settings-modal-overlay'),
            closeSettingsBtn: document.getElementById('close-settings-modal-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            resetSettingsBtn: document.getElementById('reset-all-settings-btn'),
            settingsModalBody: document.getElementById('settings-modal-body'),
            logModal: document.getElementById('log-modal-overlay'),
            closeLogBtn: document.getElementById('close-log-modal-btn'),
            mobileOpenLogBtn: document.getElementById('mobile-open-log-modal-btn'),
            logOutput: document.getElementById('log-output'),
            honorModal: document.getElementById('honor-modal-overlay'),
            closeHonorBtn: document.getElementById('close-honor-modal'),
            honorModalBody: document.getElementById('honor-modal-body'),
            honorBoardBtn: document.getElementById('honor-board-btn'),
            // Chart controls
            chartContainerView: document.getElementById('chart-container-view'),
            heatmapContainerView: document.getElementById('heatmap-container-view'),
            chartViewBtn: document.getElementById('chart-view-btn'),
            heatmapViewBtn: document.getElementById('heatmap-view-btn'),
            mobileChartViewBtn: document.getElementById('mobile-chart-view-btn'),
            mobileHeatmapViewBtn: document.getElementById('mobile-heatmap-view-btn'),
            fullscreenBtn: document.getElementById('fullscreen-chart-btn'),
            mobileFullscreenBtn: document.getElementById('mobile-fullscreen-chart-btn'),
            exitFullscreenBtn: document.getElementById('exit-fullscreen-btn'),
            chartZoomIn: document.getElementById('chart-zoom-in'),
            chartZoomOut: document.getElementById('chart-zoom-out'),
            chartZoomReset: document.getElementById('chart-zoom-reset'),
            // Signal Bars
            buySignalBar: document.getElementById('buy-signal-bar-fill'),
            sellSignalBar: document.getElementById('sell-signal-bar-fill'),
            buySignalScore: document.getElementById('buy-signal-score-text'),
            sellSignalScore: document.getElementById('sell-signal-score-text'),
        };

        this.ui.startBtn.addEventListener('click', () => this.startSystem());
        this.ui.stopBtn.addEventListener('click', () => this.stopSystem());
        this.ui.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
        this.ui.headerMainBar.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('.form-control')) return;
            document.body.classList.toggle('header-collapsed');
        });
        
        // View toggles
        this.ui.chartViewBtn.addEventListener('click', () => this.switchView('chart'));
        this.ui.heatmapViewBtn.addEventListener('click', () => this.switchView('heatmap'));
        this.ui.mobileChartViewBtn.addEventListener('click', () => this.switchView('chart'));
        this.ui.mobileHeatmapViewBtn.addEventListener('click', () => this.switchView('heatmap'));

        // Fullscreen
        this.ui.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
        this.ui.mobileFullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
        this.ui.exitFullscreenBtn.addEventListener('click', () => this.toggleFullscreen());

        // Chart Zoom
        this.ui.chartZoomIn.addEventListener('click', () => this.chart.timeScale().zoomIn());
        this.ui.chartZoomOut.addEventListener('click', () => this.chart.timeScale().zoomOut());
        this.ui.chartZoomReset.addEventListener('click', () => this.chart.timeScale().fitContent());

        // Modals
        this.ui.openSettingsBtn.addEventListener('click', () => this.openModal('settings'));
        this.ui.mobileOpenSettingsBtn.addEventListener('click', () => this.openModal('settings'));
        this.ui.closeSettingsBtn.addEventListener('click', () => this.closeModal('settings'));
        this.ui.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
        this.ui.resetSettingsBtn.addEventListener('click', () => this.resetAllSettings());
        this.ui.mobileOpenLogBtn.addEventListener('click', () => this.openModal('log'));
        this.ui.closeLogBtn.addEventListener('click', () => this.closeModal('log'));
        this.ui.honorBoardBtn.addEventListener('click', () => this.showHonorBoard());
        this.ui.closeHonorBtn.addEventListener('click', () => this.closeModal('honor'));
    }

    async loadSettings() {
        this.settings = await this.storage.getSettings('unified_app_settings', this.defaultSettings);
        this.applyTheme(this.settings.general.theme);
        this.ui.symbolInput.value = this.currentSymbol;
        this.ui.timeframeSelect.value = this.currentTimeframe;
        this.buildSettingsUI();
    }

    buildSettingsUI() {
        let html = '';
        for (const groupKey in this.settings) {
            html += `<div class="settings-group"><h4>${groupKey.toUpperCase()}</h4>`;
            for (const settingKey in this.settings[groupKey]) {
                const value = this.settings[groupKey][settingKey];
                html += `<div class="form-group">`;
                if (typeof value === 'boolean') {
                    html += `<label class="checkbox-label"><input type="checkbox" data-group="${groupKey}" data-setting="${settingKey}" ${value ? 'checked' : ''}> ${settingKey}</label>`;
                } else if (typeof value === 'string') {
                    html += `<label class="form-label">${settingKey}</label><input type="text" class="form-control" data-group="${groupKey}" data-setting="${settingKey}" value="${value}">`;
                }
                html += `</div>`;
            }
            html += `</div>`;
        }
        this.ui.settingsModalBody.innerHTML = html;
    }

    async saveSettings() {
        this.ui.settingsModalBody.querySelectorAll('input').forEach(input => {
            const group = input.dataset.group;
            const setting = input.dataset.setting;
            if (input.type === 'checkbox') {
                this.settings[group][setting] = input.checked;
            } else {
                this.settings[group][setting] = input.value;
            }
        });
        await this.storage.saveSettings('unified_app_settings', this.settings);
        this.applyTheme(this.settings.general.theme);
        this.showNotification('Ayarlar kaydedildi.', 'success');
        this.closeModal('settings');
    }
    
    async resetAllSettings() {
        if (confirm('Tüm ayarları, panteon itibarını ve geçmişi sıfırlamak istediğinize emin misiniz? Bu işlem geri alınamaz.')) {
            this.settings = JSON.parse(JSON.stringify(this.defaultSettings)); // Deep copy
            await this.storage.saveSettings('unified_app_settings', this.settings);
            await this.storage.clear('panteon');
            await this.storage.clear('kehanet');
            await this.storage.clear('history');
            await this.panteonManager.init(); // Re-initialize panteon
            this.buildSettingsUI();
            this.showNotification('Evren başarıyla sıfırlandı.', 'warning');
        }
    }

    applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        this.settings.general.theme = theme;
        if (this.chart) {
            this.chart.applyOptions(this.getChartThemeOptions(theme));
        }
    }

    toggleTheme() {
        const currentTheme = this.settings.general.theme;
        const newTheme = currentTheme === 'dark' ? 'light' : (currentTheme === 'light' ? 'war' : 'dark');
        this.applyTheme(newTheme);
        this.storage.saveSettings('unified_app_settings', this.settings);
        this.showNotification(`Tema ${newTheme} olarak değiştirildi.`, 'info');
    }

    initChart() {
        this.chart = LightweightCharts.createChart(document.getElementById('live-chart'), this.getChartThemeOptions(this.settings.general.theme));
        this.candleSeries = this.chart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
            wickUpColor: '#26a69a', wickDownColor: '#ef5350',
        });
    }
    
    getChartThemeOptions(theme) {
        const themes = {
            'dark': { layout: { background: { color: '#0d1117' }, textColor: '#c9d1d9' }, grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } } },
            'light': { layout: { background: { color: '#ffffff' }, textColor: '#1f2328' }, grid: { vertLines: { color: '#d0d7de' }, horzLines: { color: '#d0d7de' } } },
            'war': { layout: { background: { color: '#1b1302' }, textColor: '#f8ecd3' }, grid: { vertLines: { color: '#3c2a07' }, horzLines: { color: '#3c2a07' } } }
        };
        return themes[theme] || themes['dark'];
    }

    initResizeHandle() {
        const handle = document.querySelector('.resize-handle');
        const container = document.getElementById('data-container');
        const chartView = document.getElementById('chart-container-view');
        
        handle.addEventListener('mousedown', (e) => {
            this.isResizing = true;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!this.isResizing) return;
            const containerRect = container.getBoundingClientRect();
            const newChartHeight = e.clientY - containerRect.top;
            if (newChartHeight > 50 && newChartHeight < containerRect.height - 50) {
                chartView.style.height = `${newChartHeight}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (this.isResizing) {
                this.isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                this.chart.resize(chartView.clientWidth, chartView.clientHeight);
            }
        });
    }

    startSystem() {
        if (this.isSystemRunning) return;
        this.currentSymbol = this.ui.symbolInput.value.toUpperCase();
        this.currentTimeframe = this.ui.timeframeSelect.value;
        this.isSystemRunning = true;
        this.ui.startBtn.disabled = true;
        this.ui.stopBtn.disabled = false;
        this.updateConnectionStatus(true, 'BAĞLANIYOR...');
        this.connectWebSocket();
        this.showNotification('Sistem başlatıldı.', 'success');
        this.log('info', `System started for ${this.currentSymbol} on ${this.currentTimeframe}`);
    }

    stopSystem() {
        if (!this.isSystemRunning) return;
        this.isSystemRunning = false;
        this.ui.startBtn.disabled = false;
        this.ui.stopBtn.disabled = true;
        if (this.websocket) {
            this.websocket.close();
        }
        this.updateConnectionStatus(false, 'BAĞLANTI YOK');
        this.showNotification('Sistem durduruldu.', 'danger');
        this.log('warn', 'System stopped.');
        clearInterval(this.candleCountdownInterval);
    }

    connectWebSocket() {
        const streamName = `${this.currentSymbol.toLowerCase()}@kline_${this.currentTimeframe}`;
        const tickerStream = `${this.currentSymbol.toLowerCase()}@ticker`;
        this.websocket = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streamName}/${tickerStream}`);
        this.websocket.onopen = () => {
            this.updateConnectionStatus(true, 'BAĞLANDI');
            this.log('info', 'WebSocket connection established.');
            this.fetchInitialCandles();
        };
        this.websocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.stream.endsWith('@ticker')) {
                this.handleTickerData(data.data);
            } else {
                this.handleKlineData(data.data.k);
            }
        };
        this.websocket.onclose = () => {
            if (this.isSystemRunning) {
                this.updateConnectionStatus(false, 'YENİDEN BAĞLANILIYOR...');
                this.log('warn', 'WebSocket closed. Reconnecting...');
                setTimeout(() => this.connectWebSocket(), 5000);
            }
        };
        this.websocket.onerror = (error) => {
            this.log('error', `WebSocket Error: ${error.message}`);
            this.updateConnectionStatus(false, 'HATA');
        };
    }

    fetchInitialCandles() {
        fetch(`https://api.binance.com/api/v3/klines?symbol=${this.currentSymbol}&interval=${this.currentTimeframe}&limit=500`)
            .then(res => res.json())
            .then(data => {
                const formattedData = data.map(d => ({
                    time: d[0] / 1000,
                    open: parseFloat(d[1]),
                    high: parseFloat(d[2]),
                    low: parseFloat(d[3]),
                    close: parseFloat(d[4]),
                }));
                this.candleSeries.setData(formattedData);
                if (formattedData.length > 0) {
                    this.lastCandleCloseTime = formattedData[formattedData.length - 1].time * 1000 + this.getIntervalMillis();
                    this.startCandleCountdown();
                }
            });
    }

    handleTickerData(data) {
        this.ui.currentPrice.textContent = parseFloat(data.c).toFixed(2);
        const change = parseFloat(data.p);
        const changePercent = parseFloat(data.P);
        this.ui.priceChange24h.innerHTML = `<span style="color: ${change >= 0 ? 'var(--positive)' : 'var(--negative)'}">${change.toFixed(2)} (${changePercent.toFixed(2)}%)</span>`;
        this.ui.volume24h.textContent = parseFloat(data.v).toLocaleString();
        
        document.getElementById('ticker-bar-price').textContent = this.ui.currentPrice.textContent;
    }

    handleKlineData(kline) {
        const candle = {
            time: kline.t / 1000,
            open: parseFloat(kline.o),
            high: parseFloat(kline.h),
            low: parseFloat(kline.l),
            close: parseFloat(kline.c),
        };
        this.candleSeries.update(candle);
        if (kline.x) { // is closed
            this.lastCandleCloseTime = candle.time * 1000 + this.getIntervalMillis();
            this.showNotification(`${this.currentTimeframe} mum kapandı.`, 'info');
            this.panteonManager.updateReputation('raphael', 1); // Raphael gets rep on new candle
        }
        
        // Mock signal generation
        const buyScore = Math.random();
        const sellScore = Math.random();
        this.ui.buySignalBar.style.width = `${buyScore * 100}%`;
        this.ui.sellSignalBar.style.width = `${sellScore * 100}%`;
        this.ui.buySignalScore.textContent = buyScore.toFixed(2);
        this.ui.sellSignalScore.textContent = sellScore.toFixed(2);
    }

    startCandleCountdown() {
        clearInterval(this.candleCountdownInterval);
        this.candleCountdownInterval = setInterval(() => {
            const now = Date.now();
            const timeLeft = this.lastCandleCloseTime - now;
            if (timeLeft <= 0) {
                this.ui.candleCountdown.textContent = '00:00';
                this.ui.chartCountdownOverlay.textContent = '00:00';
                return;
            }
            const minutes = Math.floor((timeLeft / 1000 / 60) % 60).toString().padStart(2, '0');
            const seconds = Math.floor((timeLeft / 1000) % 60).toString().padStart(2, '0');
            const countdownText = `${minutes}:${seconds}`;
            this.ui.candleCountdown.textContent = countdownText;
            this.ui.chartCountdownOverlay.textContent = countdownText;
            this.ui.chartCountdownOverlay.style.display = this.settings.chart.showCountdown ? 'block' : 'none';
        }, 1000);
    }

    getIntervalMillis() {
        const unit = this.currentTimeframe.slice(-1);
        const value = parseInt(this.currentTimeframe.slice(0, -1));
        if (unit === 'm') return value * 60 * 1000;
        if (unit === 'h') return value * 60 * 60 * 1000;
        return 0;
    }

    updateConnectionStatus(isOnline, text) {
        this.ui.connectionStatus.classList.toggle('online', isOnline);
        this.ui.connectionText.textContent = text;
    }

    showNotification(message, type = 'info', duration = 5000) {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        this.ui.notificationsContainer.appendChild(notif);
        
        // Trigger effects
        if (type === 'success') this.effectsManager.trigger('buy');
        if (type === 'danger') this.effectsManager.trigger('sell');

        setTimeout(() => {
            notif.style.animation = 'slide-out 0.3s ease-in forwards';
            setTimeout(() => notif.remove(), 300);
        }, duration);
    }

    log(level, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-${level}`;
        logEntry.textContent = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
        this.ui.logOutput.appendChild(logEntry);
        this.ui.logOutput.scrollTop = this.ui.logOutput.scrollHeight;
    }

    openModal(type) {
        this.getModal(type).classList.add('visible');
    }

    closeModal(type) {
        this.getModal(type).classList.remove('visible');
    }
    
    getModal(type) {
        if (type === 'settings') return this.ui.settingsModal;
        if (type === 'log') return this.ui.logModal;
        if (type === 'honor') return this.ui.honorModal;
    }

    switchView(view) {
        this.ui.chartContainerView.classList.toggle('hidden-view', view !== 'chart');
        this.ui.heatmapContainerView.classList.toggle('hidden-view', view !== 'heatmap');
    }

    toggleFullscreen() {
        this.isChartFullscreen = !this.isChartFullscreen;
        const chartPanel = document.querySelector('.center-panel');
        chartPanel.classList.toggle('fullscreen', this.isChartFullscreen);
        document.body.classList.toggle('chart-fullscreen-active', this.isChartFullscreen);
        this.ui.exitFullscreenBtn.style.display = this.isChartFullscreen ? 'block' : 'none';
        
        // Force chart resize
        setTimeout(() => {
            const chartView = document.getElementById('chart-container-view');
            this.chart.resize(chartView.clientWidth, chartView.clientHeight);
        }, 50);
    }
    
    async showHonorBoard() {
        const history = await this.storage.getAllHistory();
        let tableHtml = `<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Tarih</th><th>Tip</th><th>Sonuç</th></tr></thead><tbody>`;
        history.forEach(item => {
            tableHtml += `<tr class="signal-${item.type}"><td>${item.id}</td><td>${new Date(item.timestamp).toLocaleString()}</td><td>${item.type}</td><td>${item.result}</td></tr>`;
        });
        tableHtml += `</tbody></table></div>`;
        this.ui.honorModalBody.innerHTML = tableHtml;
        this.openModal('honor');
    }
}


//================================================================================
// INITIALIZATION
//================================================================================

async function bootstrapPantheon() {
    const dbManager = new DBManager('UnifiedAppDB', 3, Migration.upgrade);
    const migration = new Migration(dbManager);
    await migration.run();

    const storage = new StorageBridge(dbManager);
    window.storage = storage; // Make storage globally available

    const panteonManager = new PanteonManager(storage);
    await panteonManager.init();
    window.panteonManager = panteonManager; // Make manager globally available

    // Kehanet Panel Logic
    document.getElementById('prophecy-defensive').addEventListener('click', () => {
        storage.setKehanet({ id: 'prophecy', value: 'defensive' });
        window.app.showNotification('Kehanet: Defansif moda geçildi.', 'info');
    });
    document.getElementById('prophecy-neutral').addEventListener('click', () => {
        storage.setKehanet({ id: 'prophecy', value: 'neutral' });
        window.app.showNotification('Kehanet: Nötr moda geçildi.', 'info');
    });
    document.getElementById('prophecy-aggressive').addEventListener('click', () => {
        storage.setKehanet({ id: 'prophecy', value: 'aggressive' });
        window.app.showNotification('Kehanet: Agresif moda geçildi.', 'warning');
        window.app.effectsManager.trigger('divine');
        window.panteonManager.updateReputation('metatron', -5);
        window.panteonManager.updateReputation('uriel', -5);
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log("Unified Application DOM content loaded. Initializing...");

    await bootstrapPantheon();
    
    const app = new UltimateTradingCommandCenter(window.storage);
    window.app = app;

    console.log("Ultimate Trading Command Center is online.");
});

//]]>
</script>
</body>
</html>
