
<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ULTIMATE TRADING KOMUTA MERKEZİ</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      /* Dark base */
      --background-dark: #0d1117; --panel-bg-dark: #161b22; --text-main-dark: #c9d1d9; --text-secondary-dark: #8b949e; --border-color-dark: #30363d; --input-bg-dark: #010409; --hover-bg-dark: #21262d; --primary-dark: #58a6ff;
      /* Light palette (tanımları hem -light hem de düz isimle veriyoruz) */
      --background-light: #ffffff; --panel-bg-light: #f6f8fa; --text-main-light: #24292f; --text-secondary-light: #57606a; --border-color-light: #d0d7de; --input-bg-light: #f0f2f5; --hover-bg-light: #e8eaed; --primary-light: #0969da;
      /* düz isimler (compat) */
      --panel-bg: #f6f8fa; --text-main: #24292f; --text-secondary: #57606a; --border-color: #d0d7de; --input-bg: #f0f2f5; --hover-bg: #e8eaed; --primary: #0969da;

      --war-mode-bg: linear-gradient(145deg, #4d0000 0%, #000000 75%); --war-mode-panel-bg: rgba(255, 0, 0, 0.08); --war-mode-border: #8B0000; --war-mode-text: #ff5858; --war-mode-primary: #ffc107;

      --positive: #28a745; --negative: #dc3545; --neutral: #ffc107;
      --ticker-height: 30px; 
      --header-min-height: 40px;
    }
    [data-theme="light"] {
      --background: var(--background-light);
      --panel-bg: var(--panel-bg-light);
      --text-main: var(--text-main-light);
      --text-secondary: var(--text-secondary-light);
      --border-color: var(--border-color-light);
      --input-bg: var(--input-bg-light);
      --hover-bg: var(--hover-bg-light);
      --primary: var(--primary-light);
    }
    [data-theme="dark"] {
      --background: var(--background-dark);
      --panel-bg: var(--panel-bg-dark);
      --text-main: var(--text-main-dark);
      --text-secondary: var(--text-secondary-dark);
      --border-color: var(--border-color-dark);
      --input-bg: var(--input-bg-dark);
      --hover-bg: var(--hover-bg-dark);
      --primary: var(--primary-dark);
    }
    [data-theme="war"] {
      --background: var(--war-mode-bg);
      --panel-bg: var(--war-mode-panel-bg);
      --text-main: var(--war-mode-text);
      --text-secondary: #ffaaaa;
      --border-color: var(--war-mode-border);
      --input-bg: rgba(255, 255, 255, 0.05);
      --hover-bg: rgba(255, 255, 255, 0.1);
      --primary: var(--war-mode-primary);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Roboto Mono', monospace; font-size: 12px; background: var(--background); color: var(--text-main); overflow: hidden; transition: background 0.5s, color 0.5s; }
    
    #super-top-ticker { display: flex; position: fixed; top: 0; left: 0; width: 100%; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); padding: 2px 10px; z-index: 1100; align-items: center; justify-content: space-between; font-size: 11px; font-weight: 700; height: var(--ticker-height); }
    .super-top-left { display: flex; align-items: center; gap: 10px; flex-shrink: 0;}
    #ticker-bar-symbol { color: var(--primary); }
    #ticker-bar-price { color: var(--text-main); font-size: 12px; }
    .super-top-right-buttons { display: flex; gap: 5px; }

    .container { display: flex; flex-direction: column; height: 100vh; padding-top: var(--ticker-height); }

    .header { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.2); margin: 5px; position: relative; }
    .header-top-bar { display: flex; align-items: center; width: 100%; padding: 5px 15px; min-height: var(--header-min-height); justify-content: space-between; cursor: pointer; font-weight: 700; font-size: 16px; color: var(--primary); }
    .header-collapsible-content { transition: max-height 0.35s ease-in-out, opacity 0.3s ease, padding 0.35s ease, visibility 0.35s; max-height: 300px; opacity: 1; overflow: hidden; visibility: visible; padding: 0 15px 8px 15px; }
    body.header-collapsed .header-collapsible-content { max-height: 0; opacity: 0; visibility: hidden; padding-top: 0; padding-bottom: 0; }

    .main-controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; padding-bottom: 8px; }
    .form-control { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 4px; padding: 4px 8px; font-family: 'Roboto Mono', monospace; }
    
    .status { display: flex; align-items: center; gap: 5px; font-size: 11px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--negative); transition: background-color 0.5s; }
    .status-dot.online { background: var(--positive); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 #28a745b3; } 70% { box-shadow: 0 0 0 6px #28a74500; } 100% { box-shadow: 0 0 0 0 #28a74500; } }
    [data-theme="war"] .status-dot.online { background: var(--war-mode-primary); animation: war-pulse 1s infinite; }
    @keyframes war-pulse { 0% { box-shadow: 0 0 0 0 #ffc107b3; } 70% { box-shadow: 0 0 0 6px #ffc10700; } 100% { box-shadow: 0 0 0 0 #ffc10700; } }
    .btn { padding: 4px 12px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-main); border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    .btn:hover { background: var(--hover-bg); border-color: var(--primary); }
    .btn-success { background: var(--positive); color: white; border-color: var(--positive); }
    .btn-danger { background: var(--negative); color: white; border-color: var(--negative); }
    .btn-tiny { padding: 2px 6px; font-size: 10px; line-height: 1; min-width: 0; white-space: nowrap; }
    
    .main-grid { display: grid; grid-template-columns: 1fr; gap: 5px; flex-grow: 1; margin: 5px; overflow: hidden; height: calc(100% - var(--header-min-height) - 10px - var(--ticker-height)); }
    body.header-collapsed .main-grid { height: calc(100vh - var(--ticker-height) - 10px); margin-top: 0; } 
    
    .panel { display: flex; flex-direction: column; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
    .panel-title { font-weight: 700; font-size: 13px; color: var(--primary); padding: 8px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;}
    .panel-content { padding: 10px; overflow-y: auto; flex-grow: 1; }
    .settings-group { margin-bottom: 15px; }
    .form-group { margin-bottom: 8px; }
    .form-label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; padding: 4px 0;}
    
    .price-display { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; width: 100%; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; font-size: 10px; margin-top: 8px; } 
    .price-item .price-label { color: var(--text-secondary); } 
    .price-item .price-value { font-size: 18px; font-weight: 700; }
    
    .center-panel { display: grid; grid-template-rows: 1fr; gap: 5px; padding: 0 !important; } 
    .data-container { display: grid; grid-template-rows: 1fr auto; overflow: hidden; height: 100%; } 
    .data-grid { position: relative; overflow: hidden; min-height: 0; } 

    #live-chart { width: 100%; height: 100%; } 
    .heatmap-container { display: grid; grid-template-rows: auto 1fr; border-top: 1px solid var(--border-color); }
    #orderbook-heatmap { width: 100%; height: 100%; display: block; }

    .chart-zoom-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
    .chart-zoom-controls .btn-tiny { background: rgba(1, 4, 9, 0.7); backdrop-filter: blur(2px); }

    .data-table-container { width: 100%; height: 100%; overflow: auto; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .data-table th, .data-table td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap;}
    .data-table th { font-weight: 700; position: sticky; top: 0; background: var(--panel-bg); z-index: 10;}
    .data-table tr:hover { background: var(--hover-bg); }
    .signal-buy { background-color: #28a74514; } .signal-sell { background-color: #dc354514; }
    .signal-tp { background-color: #28a74533; } .signal-sl { background-color: #dc354533; }
    .stat-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border-color); font-size: 12px; }
    .stat-item:last-child { border-bottom: none; } .stat-label { color: var(--text-secondary); } .stat-value { font-weight: 700; }
    .btn-sm { padding: 1px 4px; font-size: 9px; margin-left: 4px; border-radius: 3px; cursor: pointer;}
    ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 3px; }
    .notifications { position: fixed; bottom: 15px; right: 15px; z-index: 2000; width: 320px; }
    .notification { background: var(--panel-bg); border: 1px solid var(--border-color); border-left-width: 5px; border-radius: 4px; padding: 12px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 10px; }
    .notification.success { border-left-color: var(--positive); } .notification.danger { border-left-color: var(--negative); } .notification.warning { border-left-color: var(--neutral); } .notification.info { border-left-color: var(--primary); }
    
    aside#settings-panel, aside#analytics-panel { display: none !important; }
    .hidden-view { display: none !important; } 

    #settings-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2500; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    #settings-modal-overlay.visible { opacity: 1; visibility: visible; }
    .settings-modal-content { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; width: 90%; max-width: 860px; max-height: 90%; display: flex; flex-direction: column; box-shadow: 0 8px 30px rgba(0,0,0,0.4); transform: translateY(20px); transition: transform 0.3s ease; }
    #settings-modal-overlay.visible .settings-modal-content { transform: translateY(0); }
    .settings-modal-header { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 15px; color: var(--primary); }
    .settings-modal-header .close-btn { background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; padding: 0 5px; line-height: 1; }
    .settings-modal-header .close-btn:hover { color: var(--negative); }
    .settings-modal-body { padding: 15px; overflow-y: auto; flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .settings-modal-footer { padding: 12px 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }

    /* ŞEREF PANOSU MODAL */
    #board-modal-overlay { 
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; 
      z-index: 2500; opacity:0; visibility:hidden; transition: opacity 0.3s ease, visibility 0.3s ease; 
    }
    #board-modal-overlay.visible { opacity:1; visibility:visible; }

    @media screen and (max-width: 768px) {
      .container { padding-top: var(--ticker-height); }
      .header { order: 2; position: sticky; bottom: 0; top: auto; width: 100%; z-index: 1000; margin: 0; border-radius: 0; border: none; border-top: 1px solid var(--border-color); }
      .header-top-bar { flex-direction: column; align-items: center; gap: 10px; padding: 10px 15px; }
      .header-collapsible-content { padding: 0; }
      .header-collapsible-content .main-controls { flex-direction: column; align-items: center; padding: 0; width: 100%; }
      .form-control, .btn, .status { width: 100%; text-align: center; padding: 8px 10px; font-size: 11px; }
      .status { justify-content: center; }
      .price-display { grid-template-columns: repeat(2, 1fr); margin-top: 10px; }
      .price-item .price-value { font-size: 14px; } 
      .main-grid { order: 1; flex-direction: column; margin: 5px; overflow: visible; padding-bottom: 5px; height: auto; }
      .center-panel { order: 1; flex-grow: 0; height: auto; border: 1px solid var(--border-color); border-radius: 6px; background: var(--panel-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.2); margin: 0; }
      .center-panel > .panel-title { display: none; }
      .data-container { flex-direction: column; height: auto; padding: 10px; }
      .data-grid { height: 50vh; flex-shrink: 0; }
      #live-chart { height: 100%; width: 100%; } 
      .heatmap-container { height: 150px; flex-shrink: 0; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
      .settings-modal-content { width: 95%; margin: 10px; }
      .settings-modal-body { grid-template-columns: 1fr; gap: 15px; }
      .super-top-right-buttons { display: none; }
    }
  </style>
</head>
<body class="header-collapsed">
  <!-- Üst Ticker -->
  <div id="super-top-ticker">
    <div class="super-top-left">
      <span id="ticker-bar-symbol"></span>
      <span id="ticker-bar-price"></span>
    </div>
    <div class="super-top-right-buttons">
      <button id="main-controls-btn" class="btn btn-tiny">Komuta Merkezi</button>
      <button id="chart-view-btn" class="btn btn-tiny">Grafik</button>
      <button id="heatmap-view-btn" class="btn btn-tiny">Isı Haritası</button>
      <button id="open-settings-modal-btn" class="btn btn-tiny">Ayarlar</button>
      <button id="honor-btn" class="btn btn-tiny">Şerefli</button>
      <button id="dishonor-btn" class="btn btn-tiny">Şerefsizler</button>
      <button id="banned-btn" class="btn btn-tiny">Banlılar</button>
    </div>
  </div>

  <div class="container">
    <header class="header">
      <div id="header-main-bar" class="header-top-bar" title="Paneli aç/kapatmak için çift tıkla">
        <span>KOMUTA MERKEZİ KONTROLLERİ</span>
      </div>
      <div class="header-collapsible-content">
        <div class="main-controls">
          <input type="text" id="symbol-input" class="form-control" placeholder="Örn: BTC, ETH, SOL">
          <select id="timeframe-select" class="form-control">
            <option value="1m">1m</option><option value="5m">5m</option><option value="15m" selected>15m</option><option value="1h">1h</option><option value="4h">4h</option>
          </select>
          <div class="status">
            <div id="connection-status" class="status-dot"></div>
            <span id="connection-text">BAĞLANTI YOK</span>
          </div>
          <button id="theme-toggle-btn" class="btn">Tema</button>
          <button id="start-btn" class="btn btn-success">SİSTEMİ BAŞLAT</button>
          <button id="stop-btn" class="btn btn-danger" disabled>DURDUR</button>
          <button id="clear-markers-btn" class="btn">Grafik Sinyallerini Sil</button> 
        </div>
        <div class="price-display">
          <div class="price-item"><div class="price-label">FİYAT</div><div class="price-value" id="current-price">-</div></div>
          <div class="price-item"><div class="price-label">24s DEĞİŞİM</div><div class="price-value" id="price-change-24h">-</div></div>
          <div class="price-item"><div class="price-label">24s HACİM</div><div class="price-value" id="volume-24h">-</div></div>
          <div class="price-item"><div class="price-label">VOLATİLİTE (ATR)</div><div class="price-value" id="atr-value">-</div></div>
        </div>
      </div>
    </header>

    <main class="main-grid">
      <section class="center-panel panel">
        <div class="data-container">
          <div class="data-grid" id="chart-container-view">
            <div id="live-chart"></div>
            <div class="chart-zoom-controls"> 
              <button id="chart-zoom-in" class="btn btn-tiny">+</button>
              <button id="chart-zoom-out" class="btn btn-tiny">-</button>
              <button id="chart-zoom-reset" class="btn btn-tiny">Sıfırla</button>
            </div>
          </div>
          <div class="heatmap-container hidden-view" id="heatmap-container-view">
            <div class="panel-title" style="border-top: 1px solid var(--border-color); border-bottom: none;">EMİR DEFTERİ ISI HARİTASI</div>
            <canvas id="orderbook-heatmap"></canvas>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="notifications-container" class="notifications"></div>

  <!-- Ayarlar Modal -->
  <div id="settings-modal-overlay">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <span>AYARLAR & OPTİMİZASYON</span>
        <button class="close-btn" id="close-settings-modal-btn">&times;</button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-group">
          <div class="panel-title" style="margin-bottom: 10px;">Temel Parametreler</div>
          <div class="form-group"><label class="form-label">Min. Uyum Skoru (1-10)</label><input type="range" id="modal-confluence-threshold" class="form-control" min="1" max="10" value="3" step="1"></div>
          <div class="form-group"><label class="form-label">RSI Periyodu</label><input type="number" id="modal-param-rsi-period" class="form-control" value="14"></div>
          <div class="form-group"><label class="form-label">ATR Periyodu</label><input type="number" id="modal-param-atr-period" class="form-control" value="14"></div>
          <div class="form-group"><label class="form-label">Duvar Tespiti (BTC Miktarı)</label><input type="number" id="modal-param-wall-btc" class="form-control" value="20"></div>
          <div class="form-group"><label class="form-label">Risk/Ödül Oranı (R/R)</label><input type="number" id="modal-param-rr-ratio" class="form-control" value="1.5" step="0.1"></div>
        </div>
        <div class="settings-group">
          <div class="panel-title" style="margin-bottom: 10px;">Cooldown Ayarları</div>
          <div class="form-group"><label class="form-label">Genel Sinyal Cooldown (ms)</label><input type="number" id="modal-signal-cooldown-ms" class="form-control" value="15000" min="0" step="100"></div>
          <div class="form-group"><label class="form-label">Aynı Yön Sinyal Cooldown (ms)</label><input type="number" id="modal-same-direction-cooldown-ms" class="form-control" value="30000" min="0" step="100"></div>
          <div class="form-group"><label class="form-label">Ters Yön Cooldown (ms)</label><input type="number" id="modal-opposite-direction-cooldown-ms" class="form-control" value="20000" min="0" step="100"></div>
          <div class="form-group"><label class="form-label">Ters Yön Histerezis (+Puan)</label><input type="number" id="modal-reverse-hysteresis-points" class="form-control" value="2" min="0" step="1"></div>
          <div class="form-group"><label class="form-label">Proposal Timeout (ms)</label><input type="number" id="modal-proposal-timeout-ms" class="form-control" value="3000" min="500" step="100"></div>
          <div class="form-group"><label class="form-label">Strateji Teklifi Cooldown (ms)</label><input type="number" id="modal-strategy-proposal-cooldown-ms" class="form-control" value="10000" min="0" step="100"></div>
        </div>
        <div class="settings-group">
          <div class="panel-title" style="margin-bottom: 10px;">Aktif Stratejiler</div>
          <div id="modal-strategy-toggles"></div>
        </div>
        <div class="settings-group" style="grid-column: 1 / -1;">
          <div class="panel-title" style="margin-bottom: 10px;">Sinyal Geçmişi ve Analiz</div>
          <div class="data-table-container" style="max-height: 300px;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Zaman</th><th>Tip</th><th>Fiyat</th><th>TP</th><th>SL</th><th>Skor</th><th>Katkı</th><th>Durum</th>
                </tr>
              </thead>
              <tbody id="modal-signals-body"></tbody>
            </table>
          </div>
          <button id="modal-clear-signals-btn" class="btn btn-danger btn-sm" style="margin-top: 10px;">Tüm Sinyalleri Sil</button>
          <div id="modal-stats-container" style="margin-top: 15px;"></div>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button id="reset-all-settings-btn" class="btn btn-danger">AYARLARI SIFIRLA</button>
        <button id="save-settings-btn" class="btn btn-success">AYARLARI KAYDET</button>
      </div>
    </div>
  </div>

  <!-- Şeref Panosu Modal -->
  <div id="board-modal-overlay">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <span>ŞEREF PANOSU</span>
        <button class="close-btn" id="close-board-modal-btn">&times;</button>
      </div>
      <div class="settings-modal-body" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="settings-group">
          <div class="panel-title" style="margin-bottom: 10px;">Şerefli</div>
          <div id="honor-list" class="data-table-container"></div>
        </div>
        <div class="settings-group">
          <div class="panel-title" style="margin-bottom: 10px;">Şerefsizler</div>
          <div id="dishonor-list" class="data-table-container"></div>
        </div>
        <div class="settings-group">
          <div class="panel-title" style="margin-bottom: 10px;">Banlılar</div>
          <div id="banned-list" class="data-table-container"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Ses */
function playSignal(type) {
  try {
    var AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    var audioContext = new AudioCtx();
    var oscillator = audioContext.createOscillator();
    var gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    if (type === 'buy') { oscillator.type = 'triangle'; oscillator.frequency.value = 1000; }
    else if (type === 'sell') { oscillator.type = 'square'; oscillator.frequency.value = 400; }
    else if (type === 'combat') {
      oscillator.type = 'sawtooth'; oscillator.frequency.value = 800;
      gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);
      oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 1);
      return;
    }
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.5);
  } catch(e) { console.log('Ses çalınamadı:', e); }
}

/* Chart Manager */
class ChartManager {
  constructor(chartContainerId) {
    this.chartContainer = document.getElementById(chartContainerId);
    if (!this.chartContainer) throw new Error('Chart container bulunamadı!');
    this.chart = null; this.series = {}; this.signalMarkers = [];
    this._initChart();
  }
  _initChart() {
    this.chart = LightweightCharts.createChart(this.chartContainer, this._getChartOptions());
    this.series.candles = this.chart.addCandlestickSeries(this._getCandlestickOptions());
    this.series.volume = this.chart.addHistogramSeries(this._getVolumeOptions());
    window.addEventListener('resize', () => {
      if (this.chart && this.chartContainer.clientWidth > 0 && this.chartContainer.clientHeight > 0) {
        this.chart.resize(this.chartContainer.clientWidth, this.chartContainer.clientHeight);
      }
    });
  }
  updateTheme() {
    if (!this.chart) return;
    this.chart.applyOptions(this._getChartOptions());
    this.series.candles.applyOptions(this._getCandlestickOptions());
    this.series.volume.applyOptions(this._getVolumeOptions());
  }
  setData(candles) {
    if (!this.series.candles) return;
    var candleData = candles.map(c => ({ time: c.time/1000, open:c.open, high:c.high, low:c.low, close:c.close }));
    var volumeData = candles.map(c => ({ time: c.time/1000, value:c.volume, color: c.close>=c.open ? 'rgba(40,167,69,0.5)' : 'rgba(220,53,69,0.5)' }));
    this.series.candles.setData(candleData);
    this.series.volume.setData(volumeData);
    this.chart.timeScale().fitContent();
  }
  updateRealtime(kline) {
    if (!this.series.candles) return;
    var candle = { time:kline.t/1000, open:parseFloat(kline.o), high:parseFloat(kline.h), low:parseFloat(kline.l), close:parseFloat(kline.c) };
    var volume = { time:kline.t/1000, value:parseFloat(kline.v), color: candle.close>=candle.open ? 'rgba(40,167,69,0.5)' : 'rgba(220,53,69,0.5)' };
    this.series.candles.update(candle);
    this.series.volume.update(volume);
  }
  addSignalMarker(signal) {
    if (!this.series.candles) return;
    var styles = getComputedStyle(document.body);
    var marker = {
      time: signal.timestamp/1000,
      position: signal.direction==='buy' ? 'belowBar' : 'aboveBar',
      color: signal.direction==='buy' ? styles.getPropertyValue('--positive').trim() : styles.getPropertyValue('--negative').trim(),
      shape: signal.direction==='buy' ? 'arrowUp' : 'arrowDown',
      text: 'Skor: ' + (typeof signal.score==='number' ? signal.score.toFixed(1) : signal.score) + ' @ ' + this._formatMarkerPrice(signal.price)
    };
    this.signalMarkers.push(marker);
    this.series.candles.setMarkers(this.signalMarkers);
  }
  clearMarkers(){ if(!this.series.candles) return; this.signalMarkers=[]; this.series.candles.setMarkers([]); }
  zoom(factor) {
    if (!this.chart) return;
    var timeScale = this.chart.timeScale();
    var range = timeScale.getVisibleLogicalRange();
    if (!range) return;
    var newRange = { from: range.from*factor, to: range.to*factor };
    timeScale.setVisibleLogicalRange(newRange);
  }
  zoomIn(){ this.zoom(0.9); }
  zoomOut(){ this.zoom(1.1); }
  resetZoom(){ if (this.chart) this.chart.timeScale().fitContent(); }

  _getDecimalPlacesBasedOnPrice(price){ if(!price) return 2; if(price>1000) return 2; if(price>1) return 3; if(price>0.01) return 4; return 6; }
  _formatMarkerPrice(price){ var d=this._getDecimalPlacesBasedOnPrice(price); return price.toFixed(d); }
  _getChartOptions(){
    var styles = getComputedStyle(document.body);
    return {
      width: this.chartContainer.clientWidth, height: this.chartContainer.clientHeight,
      layout: { backgroundColor:'transparent', textColor: styles.getPropertyValue('--text-main').trim(), fontFamily: "'Roboto Mono', monospace" },
      grid: { vertLines:{ color:styles.getPropertyValue('--border-color').trim() }, horzLines:{ color:styles.getPropertyValue('--border-color').trim() } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      timeScale: { borderColor: styles.getPropertyValue('--border-color').trim(), timeVisible:true, secondsVisible:false, rightOffset:10 }
    };
  }
  _getCandlestickOptions(){
    var styles = getComputedStyle(document.body);
    return {
      upColor: styles.getPropertyValue('--positive').trim(), downColor: styles.getPropertyValue('--negative').trim(),
      borderVisible:false, wickUpColor: styles.getPropertyValue('--positive').trim(), wickDownColor: styles.getPropertyValue('--negative').trim(),
      priceFormat: { type:'price', precision:6, minMove:0.000001 }
    };
  }
  _getVolumeOptions(){ return { priceFormat:{ type:'volume' }, priceScaleId:'', scaleMargins:{ top:0.8, bottom:0 } }; }
}

/* Heatmap Manager */
class HeatmapManager {
  constructor(canvasId){
    this.canvas = document.getElementById(canvasId);
    if (!this.canvas) throw new Error('Heatmap canvas bulunamadı!');
    this.ctx = this.canvas.getContext('2d');
    this._resizeCanvas();
    window.addEventListener('resize', () => this._resizeCanvas());
  }
  draw(orderBook, symbolPrice){
    if (!orderBook.bids || orderBook.bids.length===0 || !orderBook.asks || orderBook.asks.length===0) { this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); return; }
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    var asks = orderBook.asks.slice().reverse(); var bids = orderBook.bids;
    var allLevels = bids.concat(asks); var maxQty = Math.max.apply(null, allLevels.map(function(l){ return l[1]; }));
    this._drawSection(asks, 'asks', maxQty, symbolPrice); this._drawSection(bids, 'bids', maxQty, symbolPrice);
  }
  updateTheme(){ this._resizeCanvas(); }
  _drawSection(levels, type, maxQty, symbolPrice){
    var styles = getComputedStyle(document.body);
    var baseColor = type==='asks' ? styles.getPropertyValue('--negative').trim() : styles.getPropertyValue('--positive').trim();
    if (levels.length===0) return;
    var heightPerLevel = (this.canvas.height/2)/levels.length;
    var priceDecimals = this._getDecimalPlaces(symbolPrice);
    var labelSkipInterval = heightPerLevel<12 ? Math.ceil(12/heightPerLevel) : 1;
    for (var i=0;i<levels.length;i++){
      var price = levels[i][0], qty = levels[i][1];
      var intensity = Math.min(Math.sqrt(qty/Math.max(1e-8,maxQty)), 1.0);
      this.ctx.fillStyle = this._hexToRgba(baseColor, intensity*0.6+0.1);
      var y = type==='asks' ? i*heightPerLevel : (this.canvas.height/2) + i*heightPerLevel;
      var barWidth = this.canvas.width * intensity;
      this.ctx.fillRect(0,y,barWidth,heightPerLevel);
      if (i % labelSkipInterval === 0) {
        this.ctx.fillStyle = intensity>0.5 ? '#FFFFFF' : styles.getPropertyValue('--text-secondary').trim();
        this.ctx.font = '10px "Roboto Mono"'; this.ctx.textAlign = 'left';
        this.ctx.fillText((qty).toFixed(2) + ' @ ' + price.toFixed(priceDecimals), 10, y + heightPerLevel - 3);
      }
    }
  }
  _getDecimalPlaces(price){ if(!price) return 2; if(price>1000) return 2; if(price>1) return 3; if(price>0.01) return 4; return 6; }
  _hexToRgba(hex, alpha){
    if(!hex || hex[0] !== '#') return 'rgba(120,120,120,' + alpha + ')';
    var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + alpha + ')';
  }
  _resizeCanvas(){
    if (this.canvas.parentElement) { this.canvas.width = this.canvas.parentElement.clientWidth; this.canvas.height = this.canvas.parentElement.clientHeight; }
  }
}

/* Strategy base + strategies (dinamik skorlu) */
class Strategy {
  constructor(bot, name){ this.bot = bot; this.name = name; this.displayName = this._getDisplayName(name); this.lastProposalTime={}; this.DEFAULT_PROPOSAL_COOLDOWN_MS=10000; }
  propose(symbol, direction, reason, score){
    var now = Date.now();
    var key = symbol + '-' + direction;
    var cooldown = (this.DEFAULT_PROPOSAL_COOLDOWN_MS || 10000);
    if (now - (this.lastProposalTime[key] || 0) < cooldown) return;

    if (this.bot && typeof this.bot.isShadowed === 'function' && this.bot.marketData && this.bot.marketData.price) {
      if (this.bot.isShadowed(this.name)) { this.bot.recordPaperProposal(this.name, direction, this.bot.marketData.price); }
    }
    this.bot.confluenceEngine.propose(this.name, direction, reason, score);
    this.lastProposalTime[key] = now;
  }
  _getDisplayName(name){ return name.replace(/([A-Z])/g,' $1').replace(/^./, function(s){return s.toUpperCase();}); }
  analyzeOrderBook(){} processTrade(){} periodicAnalyze(){}
}

/* ... Strategies ... */
class WallBounceStrategy extends Strategy {
  constructor(bot){ super(bot, 'wallBounce'); this.DISTANCE_THRESHOLD_PERCENT = 0.05/100; }
  analyzeOrderBook(orderBook){
    var currentPrice = this.bot.marketData.price; if (!currentPrice) return;
    var btcPrice = this.bot.marketData.btcPrice || 70000;
    var wallQuantityThreshold = (this.bot.settings.params.wallBtc * btcPrice) / currentPrice;
    for (var i=0;i<orderBook.asks.length;i++){
      var price = orderBook.asks[i][0], qty = orderBook.asks[i][1];
      if (qty > wallQuantityThreshold){
        var distance = (price - currentPrice)/currentPrice;
        if (distance>0 && distance < this.DISTANCE_THRESHOLD_PERCENT){
          var strength = Math.min(10, 2 + (wallQuantityThreshold>0 ? (qty / wallQuantityThreshold) : 0));
          this.propose(this.bot.currentSymbol, 'sell', 'Satış Duvarı ' + price.toFixed(this.bot.getDecimalPlaces(price)), strength); return;
        }
      }
    }
    for (var j=0;j<orderBook.bids.length;j++){
      var priceB = orderBook.bids[j][0], qtyB = orderBook.bids[j][1];
      if (qtyB > wallQuantityThreshold){
        var dist2 = (currentPrice - priceB)/currentPrice;
        if (dist2>0 && dist2 < this.DISTANCE_THRESHOLD_PERCENT){
          var strength2 = Math.min(10, 2 + (wallQuantityThreshold>0 ? (qtyB / wallQuantityThreshold) : 0));
          this.propose(this.bot.currentSymbol, 'buy', 'Alış Duvarı ' + priceB.toFixed(this.bot.getDecimalPlaces(priceB)), strength2); return;
        }
      }
    }
  }
}
class VelocityScalpingStrategy extends Strategy {
  constructor(bot){ super(bot, 'velocityScalping'); this.pricePoints=[]; this.VELOCITY_WINDOW_MS=2000; this.MIN_POINTS=20; this.VELOCITY_THRESHOLD_PERCENT=0.10/100; }
  processTrade(trade){
    var now = Date.now();
    this.pricePoints.push({ time:now, price:trade.price });
    this.pricePoints = this.pricePoints.filter(p => now - p.time < this.VELOCITY_WINDOW_MS);
    if (this.pricePoints.length < this.MIN_POINTS) return;
    var first = this.pricePoints[0], last = this.pricePoints[this.pricePoints.length-1];
    var priceChange = (last.price - first.price)/first.price;
    var intensity = Math.min(1, Math.abs(priceChange)/this.VELOCITY_THRESHOLD_PERCENT);
    var strength = Math.min(10, 2 + intensity*8);
    if (priceChange > this.VELOCITY_THRESHOLD_PERCENT) { this.propose(this.bot.currentSymbol,'buy','Fiyat Hızı: +' + (priceChange*100).toFixed(2) + '%', strength); this.pricePoints=[]; }
    else if (priceChange < -this.VELOCITY_THRESHOLD_PERCENT) { this.propose(this.bot.currentSymbol,'sell','Fiyat Hızı: ' + (priceChange*100).toFixed(2) + '%', strength); this.pricePoints=[]; }
  }
}
class RsiDivergenceStrategy extends Strategy {
  constructor(bot){ super(bot,'rsiDivergence'); }
  periodicAnalyze(){
    var c = this.bot.candles, rsi = this.bot.indicators.rsi, look = this.bot.settings.params.rsiPeriod;
    if (!c || !rsi || c.length < look+1 || rsi.length < look+1) return;
    var last = c[c.length-1], prev = c[c.length-look];
    var rLast = rsi[rsi.length-1], rPrev = rsi[rsi.length-look];
    if (!isFinite(rLast) || !isFinite(rPrev)) return;
    var swingPct = Math.abs((last.close - prev.close)/Math.max(1e-8, prev.close));
    var rsiGap = Math.abs((rLast - rPrev)/100);
    var strength = Math.max(0, Math.min(10, rsiGap*6 + swingPct*50));
    if (last.high > prev.high && rLast < rPrev) this.propose(this.bot.currentSymbol,'sell','RSI Ayı Uyuşmazlığı',strength);
    if (last.low < prev.low && rLast > rPrev) this.propose(this.bot.currentSymbol,'buy','RSI Boğa Uyuşmazlığı',strength);
  }
}
class OrderFlowMomentumStrategy extends Strategy {
  constructor(bot){ super(bot,'orderFlowMomentum'); this.trades=[]; this.WINDOW_MS=5000; }
  processTrade(trade){
    var now = Date.now();
    this.trades.push(trade);
    this.trades = this.trades.filter(t => now - t.timestamp < this.WINDOW_MS);
    if (this.trades.length < 50) return;
    var buys = this.trades.filter(t => !t.isBuyerMaker).reduce((s,t)=>s+t.quantity,0);
    var sells = this.trades.filter(t => t.isBuyerMaker).reduce((s,t)=>s+t.quantity,0);
    var total = buys + sells; if (total === 0) return;
    var ratio = Math.abs(buys - sells)/total;
    var strength = Math.min(10, 2 + ratio*8);
    if (buys/total > 0.7) { this.propose(this.bot.currentSymbol,'buy','Alıcı Akışı: %' + Math.round(buys/total*100), strength); this.trades=[]; }
    else if (sells/total > 0.7) { this.propose(this.bot.currentSymbol,'sell','Satıcı Akışı: %' + Math.round(sells/total*100), strength); this.trades=[]; }
  }
}
class LiquidityGapsStrategy extends Strategy {
  constructor(bot){ super(bot,'liquidityGaps'); this.GAP_THRESHOLD_PERCENT=0.1/100; }
  analyzeOrderBook(orderBook){
    for (var i=0;i<orderBook.asks.length-1;i++){
      var gap = orderBook.asks[i+1][0] - orderBook.asks[i][0];
      if ((gap / orderBook.asks[i][0]) > this.GAP_THRESHOLD_PERCENT){
        var strength = Math.min(10, 2 + (gap/orderBook.asks[i][0])*300);
        this.propose(this.bot.currentSymbol,'buy','Likidite Boşluğu ' + orderBook.asks[i][0].toFixed(this.bot.getDecimalPlaces(orderBook.asks[i][0])), strength); return;
      }
    }
    for (var j=0;j<orderBook.bids.length-1;j++){
      var gapB = orderBook.bids[j][0] - orderBook.bids[j+1][0];
      if ((gapB / orderBook.bids[j][0]) > this.GAP_THRESHOLD_PERCENT){
        var strength2 = Math.min(10, 2 + (gapB/orderBook.bids[j][0])*300);
        this.propose(this.bot.currentSymbol,'sell','Likidite Boşluğu ' + orderBook.bids[j][0].toFixed(this.bot.getDecimalPlaces(orderBook.bids[j][0])), strength2); return;
      }
    }
  }
}
class BreakoutPatternStrategy extends Strategy {
  constructor(bot){ super(bot,'breakoutPattern'); this.LOOKBACK=30; this.VOL_SPIKE=1.4; this.BREAK_PCT=0.03/100; }
  periodicAnalyze(){
    var c = this.bot.candles; if (!c || c.length < this.LOOKBACK+1) return;
    var recent = c.slice(-this.LOOKBACK-1);
    var highs = recent.map(x=>x.high), lows = recent.map(x=>x.low), vols = recent.map(x=>x.volume);
    var last = recent[recent.length-1];
    var maxH = Math.max.apply(null, highs.slice(0,-1));
    var minL = Math.min.apply(null, lows.slice(0,-1));
    var volSma = vols.slice(0,-1).reduce((a,b)=>a+b,0)/Math.max(1, vols.length-1);
    var volIntensity = Math.min(1.5, last.volume/Math.max(1e-8, volSma));
    var strength = Math.min(10, 2 + (volIntensity-1)*10);
    if (last.close > maxH*(1+this.BREAK_PCT) && last.volume > volSma*this.VOL_SPIKE) this.propose(this.bot.currentSymbol,'buy','Aralık Üstü Hacimli Kırılım', strength);
    else if (last.close < minL*(1-this.BREAK_PCT) && last.volume > volSma*this.VOL_SPIKE) this.propose(this.bot.currentSymbol,'sell','Aralık Altı Hacimli Kırılım', strength);
  }
}
class SupportResistanceStrategy extends Strategy {
  constructor(bot){ super(bot,'supportResistance'); this.LOOKBACK=60; this.THRESH=0.15/100; }
  periodicAnalyze(){
    var c = this.bot.candles; if (!c || c.length < this.LOOKBACK) return;
    var slice = c.slice(-this.LOOKBACK);
    var last = slice[slice.length-1];
    var maxH = Math.max.apply(null, slice.map(x=>x.high));
    var minL = Math.min.apply(null, slice.map(x=>x.low));
    var distTop = (maxH - last.close)/last.close;
    var distBot = (last.close - minL)/last.close;
    var proximity = 1 - Math.min(1, Math.min(distTop, distBot)/this.THRESH);
    var strength = Math.min(10, 2 + Math.max(0, proximity)*8);
    if (distTop >= 0 && distTop < this.THRESH && last.close<last.open) this.propose(this.bot.currentSymbol,'sell','Direnç Bölgesi Reddi', strength);
    if (distBot >= 0 && distBot < this.THRESH && last.close>last.open) this.propose(this.bot.currentSymbol,'buy','Destek Bölgesi Tepkisi', strength);
  }
}
class FibonacciRetracementStrategy extends Strategy {
  constructor(bot){ super(bot,'fibonacciRetracement'); this.LOOKBACK=120; this.TOL=0.2/100; this.levels=[0.382,0.5,0.618]; }
  periodicAnalyze(){
    var c = this.bot.candles; if (!c || c.length < this.LOOKBACK) return;
    var slice = c.slice(-this.LOOKBACK);
    var high=-Infinity, low=Infinity, hT=0, lT=0;
    for (var i=0;i<slice.length;i++){ var k = slice[i]; if (k.high>high){high=k.high; hT=k.time;} if (k.low<low){low=k.low; lT=k.time;} }
    if (!isFinite(high) || !isFinite(low) || high===low) return;
    var last = slice[slice.length-1];
    if (hT > lT){
      var retr = (high - last.close)/(high - low);
      for (var j=0;j<this.levels.length;j++){
        var L = this.levels[j];
        if (Math.abs(retr - L) < this.TOL){ var strength = Math.min(10, 2 + (this.TOL - Math.abs(retr-L))*2000); this.propose(this.bot.currentSymbol,'buy','Fibo ' + Math.round(L*100) + '% Bölgesi', strength); break; }
      }
    } else {
      var retr2 = (last.close - low)/(high - low);
      for (var z=0;z<this.levels.length;z++){
        var L2 = this.levels[z];
        if (Math.abs(retr2 - L2) < this.TOL){ var strength2 = Math.min(10, 2 + (this.TOL - Math.abs(retr2-L2))*2000); this.propose(this.bot.currentSymbol,'sell','Fibo ' + Math.round(L2*100) + '% Bölgesi', strength2); break; }
      }
    }
  }
}
class VolumeProfileStrategy extends Strategy {
  constructor(bot){ super(bot,'volumeProfile'); this.PERIOD=20; this.SPIKE=2.0; this.CLOSE_POS=0.7; }
  periodicAnalyze(){
    var c = this.bot.candles; if (!c || c.length < this.PERIOD+1) return;
    var last = c[c.length-1];
    var vols = c.slice(-this.PERIOD-1, -1).map(x=>x.volume);
    var volSma = vols.reduce((a,b)=>a+b,0)/Math.max(1,vols.length);
    var posUp = (last.close - last.low)/Math.max(1e-8, (last.high - last.low));
    var posDn = (last.high - last.close)/Math.max(1e-8, (last.high - last.low));
    var intensity = Math.min(2, last.volume/Math.max(1e-8, volSma));
    var strength = Math.min(10, 2 + (intensity-1)*8);
    if (last.volume > volSma*this.SPIKE && posUp > this.CLOSE_POS) this.propose(this.bot.currentSymbol,'buy','Hacim Spike - Üst Kapanış', strength);
    else if (last.volume > volSma*this.SPIKE && posDn > this.CLOSE_POS) this.propose(this.bot.currentSymbol,'sell','Hacim Spike - Alt Kapanış', strength);
  }
}
class SmartMoneyConceptsStrategy extends Strategy {
  constructor(bot){ super(bot,'smartMoneyConcepts'); this.GAP_MIN_PCT=0.05/100; }
  periodicAnalyze(){
    var c = this.bot.candles; if (!c || c.length < 3) return;
    var a = c[c.length-3], d = c[c.length-1];
    if ((d.low - a.high)/Math.max(1e-8, d.low) > this.GAP_MIN_PCT) this.propose(this.bot.currentSymbol,'buy','Bullish FVG',4);
    if ((a.low - d.high)/Math.max(1e-8, d.high) > this.GAP_MIN_PCT) this.propose(this.bot.currentSymbol,'sell','Bearish FVG',4);
  }
}
class DivergenceDetectionStrategy extends Strategy {
  constructor(bot){ super(bot,'divergenceDetection'); this.LOOKBACK=40; this.SWING=3; }
  periodicAnalyze(){
    var c = this.bot.candles, rsi = this.bot.indicators.rsi;
    if (!rsi || !c || c.length < this.LOOKBACK || rsi.length < this.LOOKBACK) return;
    var slice = c.slice(-this.LOOKBACK), r = rsi.slice(-this.LOOKBACK);
    var pivLows=[], pivHighs=[];
    for (var i=this.SWING;i<slice.length-this.SWING;i++){
      var leftL = slice.slice(i-this.SWING,i).map(x=>x.low), rightL = slice.slice(i+1,i+1+this.SWING).map(x=>x.low);
      var leftH = slice.slice(i-this.SWING,i).map(x=>x.high), rightH = slice.slice(i+1,i+1+this.SWING).map(x=>x.high);
      if (slice[i].low < Math.min.apply(null,leftL) && slice[i].low < Math.min.apply(null,rightL)) pivLows.push(i);
      if (slice[i].high > Math.max.apply(null,leftH) && slice[i].high > Math.max.apply(null,rightH)) pivHighs.push(i);
    }
    if (pivLows.length>=2){
      var i1 = pivLows[pivLows.length-2], i2 = pivLows[pivLows.length-1];
      var strength = Math.min(10, 2 + Math.abs(r[i2]-r[i1])/10);
      if (slice[i2].low < slice[i1].low && r[i2] > r[i1]) this.propose(this.bot.currentSymbol,'buy','Bullish RSI Divergence (Pivot)', strength);
    }
    if (pivHighs.length>=2){
      var j1 = pivHighs[pivHighs.length-2], j2 = pivHighs[pivHighs.length-1];
      var strength2 = Math.min(10, 2 + Math.abs(r[j2]-r[j1])/10);
      if (slice[j2].high > slice[j1].high && r[j2] < r[j1]) this.propose(this.bot.currentSymbol,'sell','Bearish RSI Divergence (Pivot)', strength2);
    }
  }
}
class MarketStructureStrategy extends Strategy {
  constructor(bot){ super(bot,'marketStructure'); this.SWING=3; }
  periodicAnalyze(){
    var c = this.bot.candles; if (!c || c.length < 2*this.SWING+5) return;
    var pivotHighs=[], pivotLows=[];
    for (var i=this.SWING;i<c.length-this.SWING;i++){
      var leftH = c.slice(i-this.SWING,i).map(x=>x.high), rightH = c.slice(i+1,i+1+this.SWING).map(x=>x.high);
      var leftL = c.slice(i-this.SWING,i).map(x=>x.low), rightL = c.slice(i+1,i+1+this.SWING).map(x=>x.low);
      if (c[i].high > Math.max.apply(null,leftH) && c[i].high > Math.max.apply(null,rightH)) pivotHighs.push(i);
      if (c[i].low < Math.min.apply(null,leftL) && c[i].low < Math.min.apply(null,rightL)) pivotLows.push(i);
    }
    var last = c[c.length-1];
    var lastPH = pivotHighs.length ? c[pivotHighs[pivotHighs.length-1]].high : null;
    var lastPL = pivotLows.length ? c[pivotLows[pivotLows.length-1]].low : null;
    if (lastPH && last.close > lastPH) this.propose(this.bot.currentSymbol,'buy','Yapı Kırılımı (BOS Up)', 4);
    if (lastPL && last.close < lastPL) this.propose(this.bot.currentSymbol,'sell','Yapı Kırılımı (BOS Down)', 4);
  }
}
class InstitutionalOrderFlowStrategy extends Strategy {
  constructor(bot){ super(bot,'institutionalOrderFlow'); this.TOP_N=5; this.IMB_THRESHOLD=2.0; }
  analyzeOrderBook(orderBook){
    if (!orderBook.bids.length || !orderBook.asks.length) return;
    var topB = orderBook.bids.slice(0,this.TOP_N).reduce((s,v)=>s+v[1],0);
    var topA = orderBook.asks.slice(0,this.TOP_N).reduce((s,v)=>s+v[1],0);
    var ratio = Math.max(topB, topA)/Math.max(1e-8, Math.min(topB, topA));
    var strength = Math.min(10, 2 + (ratio-1)*4);
    if (topB/Math.max(1e-8, topA) > this.IMB_THRESHOLD) this.propose(this.bot.currentSymbol,'buy','Orderbook İmbalansı (Bid Ağırlık)', strength);
    else if (topA/Math.max(1e-8, topB) > this.IMB_THRESHOLD) this.propose(this.bot.currentSymbol,'sell','Orderbook İmbalansı (Ask Ağırlık)', strength);
  }
}
class MicroSpreadArbitrageStrategy extends Strategy {
  constructor(bot){ super(bot,'microSpreadArbitrage'); this.SPREAD_PCT=0.08/100; }
  analyzeOrderBook(orderBook){
    if (!orderBook.bids.length || !orderBook.asks.length) return;
    var bestBid = orderBook.bids[0][0], bestAsk = orderBook.asks[0][0];
    var mid = (bestAsk + bestBid)/2;
    var spreadPct = (bestAsk - bestBid)/mid;
    if (spreadPct > this.SPREAD_PCT){
      var current = this.bot.marketData.price || mid;
      var strength = Math.min(10, 2 + (spreadPct/this.SPREAD_PCT - 1)*3);
      if (current < mid) this.propose(this.bot.currentSymbol,'buy','Geniş Spread - Mean Reversion', strength);
      else this.propose(this.bot.currentSymbol,'sell','Geniş Spread - Mean Reversion', strength);
    }
  }
}
class VWAPReversionStrategy extends Strategy {
  constructor(bot){ super(bot,'vwapReversion'); this.MULT=1.0; }
  periodicAnalyze(){
    var price = this.bot.marketData.price, vwap = this.bot.indicators.vwap, atr = this.bot.indicators.atr;
    if (!price || !vwap || !atr) return;
    var dev = atr/price;
    var diffPct = (price - vwap)/vwap;
    var intensity = Math.abs(diffPct)/Math.max(1e-8, this.MULT*dev);
    var strength = Math.min(10, 2 + Math.min(1,intensity)*8);
    if (diffPct > this.MULT*dev) this.propose(this.bot.currentSymbol,'sell','VWAP Üstü Aşırı Sapma', strength);
    if (diffPct < -this.MULT*dev) this.propose(this.bot.currentSymbol,'buy','VWAP Altı Aşırı Sapma', strength);
  }
}
class SuperTrendStrategy extends Strategy {
  constructor(bot){ super(bot,'superTrend'); this.MULT=3.0; this.PERIOD=14; }
  periodicAnalyze(){
    var c = this.bot.candles, atr = this.bot.indicators.atr;
    if (!atr || !c || c.length<2) return;
    var last = c[c.length-1];
    var m = (last.high + last.low)/2;
    var upper = m + this.MULT*atr, lower = m - this.MULT*atr;
    var delta = Math.abs(last.close - m)/Math.max(1e-8, atr*this.MULT);
    var strength = Math.min(10, 2 + Math.min(1,delta)*8);
    if (last.close > upper) this.propose(this.bot.currentSymbol,'buy','ATR Kanal Üstü Kırılım (SuperTrend)', strength);
    else if (last.close < lower) this.propose(this.bot.currentSymbol,'sell','ATR Kanal Altı Kırılım (SuperTrend)', strength);
  }
}

/* Confluence + shadow/mute */
class ConfluenceEngine {
  constructor(bot){ this.bot = bot; this.proposals=[]; this.lastSignalTime=0; this.lastSignalTimeByDirection={buy:0,sell:0}; this.lastDirection=null; }
  propose(strategy, direction, reason, score){
    var now = Date.now();
    this.proposals = this.proposals.filter(p => !(p.strategy===strategy));
    var muted = this.bot.isShadowed(strategy);
    this.proposals.push({ strategy, direction, reason, score, timestamp: now, muted: muted });
    var s = this.bot.strategyStats[strategy] || { alpha:3, beta:2, proposals:0, contrib:0, wins:0, losses:0, lastUpdate: now };
    s.proposals += 1; s.lastUpdate = now; this.bot.strategyStats[strategy] = s; this.bot.saveStrategyStats();
    this.checkConfluence();
  }
  _computeDirectional(direction){
    var now = Date.now();
    var decaySec = (this.bot.settings.optimization.timeDecaySec || 3);
    var groupSums = { trending:0, meanReversion:0, neutral:0 };
    var used = [];
    var arr = this.proposals.filter(p => p.direction===direction);
    for (var i=0;i<arr.length;i++){
      var p = arr[i];
      var w = this.bot.getStrategyWeight(p.strategy);
      var ageSec = (now - p.timestamp)/1000;
      var decay = Math.exp(-ageSec/decaySec);
      var eff = (p.score||0) * w * decay;
      if (p.muted){
        var strong = (p.score||0) >= (this.bot.shadowConfig ? this.bot.shadowConfig.strongScore : 7.5);
        var factor = strong ? 1.0 : (this.bot.shadowConfig ? this.bot.shadowConfig.factor : 0.15);
        eff *= factor;
      }
      var grp = this.bot.getStrategyGroup(p.strategy);
      groupSums[grp] = (groupSums[grp] || 0) + eff;
      used.push({ strategy:p.strategy, baseScore:p.score, weight:w, decay:decay, effScore:eff, muted:!!p.muted });
    }
    var score = Math.sqrt(Math.max(0,groupSums.trending)**2 + Math.max(0,groupSums.meanReversion)**2 + Math.max(0,groupSums.neutral)**2);
    return { score:score, contributors:used, groupSums:groupSums };
  }
  checkConfluence(){
    var now = Date.now();
    var cd = this.bot.settings.cooldowns || {};
    var proposalTimeout = cd.proposalTimeoutMs || 3000;
    var signalCooldown = cd.signalMs || 15000;
    var sameDirCooldown = cd.sameDirectionMs || 30000;
    var oppCooldown = cd.oppositeDirectionMs || 20000;
    var reverseHys = cd.reverseHysteresisPoints || 2;
    var dirMargin = (this.bot.settings.optimization.dirMargin || 0.5);
    var minThreshold = this.bot.getEffectiveThreshold();

    if (now - this.lastSignalTime < signalCooldown) return;
    this.proposals = this.proposals.filter(p => now - p.timestamp < proposalTimeout);

    var buy = this._computeDirectional('buy');
    var sell = this._computeDirectional('sell');

    var buyPenalty = this.bot.marketGatingPenalty('buy') + this.bot.getHTFPenalty('buy');
    var sellPenalty = this.bot.marketGatingPenalty('sell') + this.bot.getHTFPenalty('sell');

    var feats = this.bot.buildFeatures(buy, sell);
    var pTP = this.bot.classifier ? this.bot.classifier.predict(feats) : 0.55;
    var pThresh = (this.bot.settings.optimization.probThreshold || 0.55);

    var chosen = null;
    if (buy.score >= (minThreshold + buyPenalty) && (buy.score > sell.score + dirMargin)){
      if (now - this.lastSignalTimeByDirection.buy < sameDirCooldown) return;
      if (this.lastDirection==='sell' && (now - this.lastSignalTime) < oppCooldown){
        if (buy.score < (minThreshold + buyPenalty + reverseHys)) return;
      }
      chosen = { dir:'buy', obj: buy };
    } else if (sell.score >= (minThreshold + sellPenalty) && (sell.score > buy.score + dirMargin)){
      if (now - this.lastSignalTimeByDirection.sell < sameDirCooldown) return;
      if (this.lastDirection==='buy' && (now - this.lastSignalTime) < oppCooldown){
        if (sell.score < (minThreshold + sellPenalty + reverseHys)) return;
      }
      chosen = { dir:'sell', obj: sell };
    } else { return; }

    if (pTP < pThresh) return;

    this.generateFinalSignal(chosen.dir, chosen.obj.contributors, feats, pTP);
  }
  generateFinalSignal(direction, contributors, features, prob){
    var contributingStrats = contributors.map(c => (this.bot.strategies[c.strategy] && this.bot.strategies[c.strategy].displayName) || c.strategy).join(', ');
    var weightedScore = contributors.reduce((s,c)=> s + c.effScore, 0);

    var signal = {
      id: 'sig_' + Date.now(),
      timestamp: Date.now(),
      symbol: this.bot.currentSymbol,
      direction: direction,
      price: this.bot.marketData.price,
      score: weightedScore,
      reason: contributingStrats,
      contributors: contributors,
      status: 'active',
      note: '',
      mfeR: 0, beDone:false, trailingStage:0,
      features: features, prob: prob
    };
    this.bot.calculateDynamicTpSl(signal);
    this.bot.addFinalSignal(signal);

    this.proposals = [];
    var now = Date.now();
    this.lastSignalTime = now;
    this.lastSignalTimeByDirection[direction] = now;
    this.lastDirection = direction;
  }
}

/* Online Logistic */
class OnlineLogit {
  constructor(bot){ this.bot = bot; this.key='utc_logit'; this.model = this.bot.loadData(this.key) || { w: [] }; }
  sigmoid(z){ return 1/(1+Math.exp(-z)); }
  predict(feat){ var w=this.model.w; var z=0; for(var i=0;i<feat.length;i++){ z += (w[i]||0)*feat[i]; } return this.sigmoid(z); }
  update(y, feat, lr=0.05, l2=1e-4){
    var p = this.predict(feat);
    var w = this.model.w.length ? this.model.w : new Array(feat.length).fill(0);
    for (var i=0;i<feat.length;i++){
      var grad = (p - y)*feat[i] + l2*w[i];
      w[i] = w[i] - lr*grad;
    }
    this.model.w = w; this.bot.saveData(this.key, this.model);
  }
}

/* Main App */
class UltimateTradingCommandCenter {
  constructor(){
    this.allStrategiesMap = {
      wallBounce: WallBounceStrategy,
      velocityScalping: VelocityScalpingStrategy,
      rsiDivergence: RsiDivergenceStrategy,
      orderFlowMomentum: OrderFlowMomentumStrategy,
      liquidityGaps: LiquidityGapsStrategy,
      fibonacciRetracement: FibonacciRetracementStrategy,
      volumeProfile: VolumeProfileStrategy,
      smartMoneyConcepts: SmartMoneyConceptsStrategy,
      divergenceDetection: DivergenceDetectionStrategy,
      breakoutPattern: BreakoutPatternStrategy,
      supportResistance: SupportResistanceStrategy,
      marketStructure: MarketStructureStrategy,
      institutionalOrderFlow: InstitutionalOrderFlowStrategy,
      microSpreadArbitrage: MicroSpreadArbitrageStrategy,
      vwapReversion: VWAPReversionStrategy,
      superTrend: SuperTrendStrategy
    };
    this.allStrategyKeys = Object.keys(this.allStrategiesMap);

    this.isRunning=false; this.sockets={};
    this.currentSymbol = this.loadData('utc_current_symbol') || 'BTCUSDT';
    this.currentTimeframe = this.loadData('utc_current_timeframe') || '15m';
    this.headerCollapsed = (this.loadData('utc_header_collapsed') !== null) ? (this.loadData('utc_header_collapsed') === true || this.loadData('utc_header_collapsed') === 'true') : true;
    this.currentMainView = this.loadData('utc_current_view') || 'chart';

    this.marketData = {};
    this.orderBook = { bids:[], asks:[], lastUpdateId:null };
    this.aggTrades = [];
    this.candles = [];
    this.indicators = { rsi:[], atr:null, sma20:null, sma50:null, volSma20:null, vwap:null, adx:null };
    this.signals = this.loadData('utc_signals') || [];
    this.stats = this.loadData('utc_stats') || { total:0, tp:0, sl:0 };

    this.strategyStats = this.loadData('utc_strategy_stats') || this.initDefaultStrategyStats();
    this.ctxStats = this.loadData('utc_ctx_stats') || {};
    this.marketRegime = 'unknown';
    this.strategyGroups = {
      trending: ['breakoutPattern','orderFlowMomentum','marketStructure','volumeProfile','smartMoneyConcepts','superTrend'],
      meanReversion: ['vwapReversion','wallBounce','liquidityGaps','fibonacciRetracement','supportResistance','microSpreadArbitrage','divergenceDetection','rsiDivergence','institutionalOrderFlow']
    };

    this.shadow = this.loadData('utc_shadow') || { byStrategy:{} };
    this.paperEval = { queue:[] };
    this.shadowConfig = { factor:0.15, strongScore:7.5, probationWinsNeeded:4, probationWindow:8, lookaheadMs:15*60*1000, paperR:0.5, banDurMs:60*60*1000 };

    this.settings = this.loadSettings();
    this.strategies = {};

    this.combatModeActive=false;
    this.reconnectAttempts=0; this.reconnectDelay=3000;
    this.chartManager = new ChartManager('live-chart');
    this.heatmapManager = new HeatmapManager('orderbook-heatmap');
    this.confluenceEngine = new ConfluenceEngine(this);
    this.classifier = new OnlineLogit(this);

    this.renderInterval=null; this.analysisInterval=null; this.cooldownTuneInterval=null; this.thresholdTuneInterval=null;
    this._paperTimer=null; this._honorTimer=null; this._htfTimer=null;
    this.lastAutoToggleTs=0; this.runtimeThresholdOffset=0; this.riskState='neutral'; this.htfTrend='flat';

    this.init();
  }

  initDefaultStrategyStats(){
    var stats={}; for (var i=0;i<this.allStrategyKeys.length;i++){ var k=this.allStrategyKeys[i]; stats[k] = { alpha:3, beta:2, proposals:0, contrib:0, wins:0, losses:0, lastUpdate: Date.now() }; }
    return stats;
  }
  saveStrategyStats(){ this.saveData('utc_strategy_stats', this.strategyStats); }
  saveCtxStats(){ this.saveData('utc_ctx_stats', this.ctxStats); }

  getStrategyGroup(key){
    if (this.strategyGroups.trending.indexOf(key) !== -1) return 'trending';
    if (this.strategyGroups.meanReversion.indexOf(key) !== -1) return 'meanReversion';
    return 'neutral';
  }
  getGroupBoost(key){
    var grp = this.getStrategyGroup(key);
    var boost = 1.0;
    if (this.marketRegime==='trend' && grp==='trending') boost*=1.15;
    if (this.marketRegime==='range' && grp==='meanReversion') boost*=1.15;
    var atrPct = (this.indicators.atr && this.marketData.price) ? (this.indicators.atr/this.marketData.price) : 0;
    if (atrPct < 0.005){ if (grp==='trending') boost*=0.9; if (grp==='meanReversion') boost*=1.05; }
    else if (atrPct > 0.02){ if (grp==='trending') boost*=1.05; if (grp==='meanReversion') boost*=0.95; }
    return boost;
  }
  getContextKey(){
    var regime = this.marketRegime || 'unknown';
    var atrPct = (this.indicators.atr && this.marketData.price) ? (this.indicators.atr/this.marketData.price) : 0;
    var volBucket = atrPct < 0.005 ? 'vlow' : atrPct < 0.012 ? 'low' : atrPct < 0.02 ? 'mid' : 'high';
    var ob = this.getOrderBookSnapshotInfo() || {};
    var liqBucket = (ob.minTopUsd || 0) < 5e4 ? 'thin' : ((ob.minTopUsd || 0) < 2e5 ? 'mid' : 'deep');
    return regime + '|' + volBucket + '|' + liqBucket + '|' + this.currentTimeframe;
  }
  getStrategyWeight(name){
    var global = this.strategyStats[name] || { alpha:3, beta:2 };
    var ctxKey = this.getContextKey();
    var ctxForStrat = (this.ctxStats[name] && this.ctxStats[name][ctxKey]) || null;
    var pick = ctxForStrat || global;
    var mean = pick.alpha / (pick.alpha + pick.beta);
    var variance = (pick.alpha * pick.beta) / (Math.pow(pick.alpha + pick.beta,2) * (pick.alpha + pick.beta + 1));
    var uncertaintyPenalty = Math.max(0.75, 1 - Math.sqrt(variance)*3);
    var w = (0.5 + mean) * uncertaintyPenalty;
    w *= this.getGroupBoost(name);
    w = Math.max(0.25, Math.min(2.2, w));
    return w;
  }

  init(){
    this.initStrategies();
    this.setupUI();
    this.setupEventListeners();
    this.renderSignals(true);
    this.renderStats(true);
    this.logToJournal('Sistem hazır. "SİSTEMİ BAŞLAT" butonuna tıklayın.');
    if (this.headerCollapsed) document.body.classList.add('header-collapsed'); else document.body.classList.remove('header-collapsed');
    this.switchMainView(this.currentMainView);
  }
  initStrategies(){
    this.strategies = {};
    for (var i=0;i<this.allStrategyKeys.length;i++){
      var key = this.allStrategyKeys[i];
      var StrategyClass = this.allStrategiesMap[key];
      this.strategies[key] = new StrategyClass(this);
    }
    this.updateActiveStrategies();
  }
  updateActiveStrategies(){
    for (var k in this.strategies){ if (this.strategies.hasOwnProperty(k)) this.strategies[k].DEFAULT_PROPOSAL_COOLDOWN_MS = this.settings.cooldowns.strategyProposalMs; }
    this.activeStrategies = {};
    for (var k2 in this.strategies){ if (this.strategies.hasOwnProperty(k2) && this.settings.activeStrategies[k2]) this.activeStrategies[k2] = this.strategies[k2]; }
  }

  setupUI(){
    var symInput = document.getElementById('symbol-input');
    if (symInput) symInput.value = this.currentSymbol.replace('USDT','');
    var tfSelect = document.getElementById('timeframe-select');
    if (tfSelect) tfSelect.value = this.currentTimeframe;

    this.updateSettingsModalUI();
    var savedTheme = localStorage.getItem('utc_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    this.chartManager.updateTheme();
    this.heatmapManager.updateTheme();
    this.updateSuperTopTicker();
  }
  updateSuperTopTicker(){ var el = document.getElementById('ticker-bar-symbol'); if (el) el.textContent = this.currentSymbol.replace('USDT','/USDT'); }

  updateSettingsModalUI(){
    var g = this.settings;
    var setVal = function(id, val){ var el = document.getElementById(id); if (el) el.value = val; };

    setVal('modal-confluence-threshold', g.confluenceThreshold);
    setVal('modal-param-rsi-period', g.params.rsiPeriod);
    setVal('modal-param-atr-period', g.params.atrPeriod);
    setVal('modal-param-wall-btc', g.params.wallBtc);
    setVal('modal-param-rr-ratio', g.params.rrRatio);

    setVal('modal-signal-cooldown-ms', g.cooldowns.signalMs);
    setVal('modal-same-direction-cooldown-ms', g.cooldowns.sameDirectionMs);
    setVal('modal-opposite-direction-cooldown-ms', g.cooldowns.oppositeDirectionMs);
    setVal('modal-reverse-hysteresis-points', g.cooldowns.reverseHysteresisPoints);
    setVal('modal-proposal-timeout-ms', g.cooldowns.proposalTimeoutMs);
    setVal('modal-strategy-proposal-cooldown-ms', g.cooldowns.strategyProposalMs);

    var container = document.getElementById('modal-strategy-toggles');
    if (container){
      container.innerHTML = '';
      for (var i=0;i<this.allStrategyKeys.length;i++){
        var key = this.allStrategyKeys[i];
        var strategy = this.strategies[key];
        var isChecked = !!this.settings.activeStrategies[key];
        var isShadow = this.isShadowed(key);
        container.innerHTML += '<div class="form-group"><label class="checkbox-label">' +
          '<input type="checkbox" class="strategy-toggle" data-strategy-key="' + key + '" ' + (isChecked ? 'checked' : '') + '> ' +
          strategy.displayName + (isShadow ? ' <span style="color:#ffc107;font-size:10px;">[shadow]</span>' : '') +
          '</label></div>';
      }
    }

    this.renderSignals(true);
    this.renderStats(true);
  }

  setupEventListeners(){
    var self = this;
    var byId = function(id){ return document.getElementById(id); };

    var startBtn = byId('start-btn'); if (startBtn) startBtn.addEventListener('click', function(){ self.start(); });
    var stopBtn = byId('stop-btn'); if (stopBtn) stopBtn.addEventListener('click', function(){ self.stop(); });
    var themeBtn = byId('theme-toggle-btn'); if (themeBtn) themeBtn.addEventListener('click', function(){ self.toggleTheme(); });
    var symInput = byId('symbol-input'); if (symInput) symInput.addEventListener('change', function(e){
      var newSymbol = (e.target.value || '').toUpperCase(); if (!newSymbol.endsWith('USDT')) newSymbol += 'USDT';
      self.changeSymbol(newSymbol); self.saveData('utc_current_symbol', newSymbol);
    });
    var tfSelect = byId('timeframe-select'); if (tfSelect) tfSelect.addEventListener('change', function(e){ self.changeTimeframe(e.target.value); self.saveData('utc_current_timeframe', e.target.value); });

    var headerBar = byId('header-main-bar'); if (headerBar) headerBar.addEventListener('dblclick', function(){ self.toggleControlsPanel(); self.saveData('utc_header_collapsed', self.headerCollapsed); });
    var mcBtn = byId('main-controls-btn'); if (mcBtn) mcBtn.addEventListener('click', function(){ self.toggleControlsPanel(); self.saveData('utc_header_collapsed', self.headerCollapsed); });

    var chartBtn = byId('chart-view-btn'); if (chartBtn) chartBtn.addEventListener('click', function(){ self.switchMainView('chart'); self.saveData('utc_current_view','chart'); });
    var heatBtn = byId('heatmap-view-btn'); if (heatBtn) heatBtn.addEventListener('click', function(){ self.switchMainView('heatmap'); self.saveData('utc_current_view','heatmap'); });

    var openSettings = byId('open-settings-modal-btn'); if (openSettings) openSettings.addEventListener('click', function(){ self.openSettingsModal(); });
    var clearMarkers = byId('clear-markers-btn'); if (clearMarkers) clearMarkers.addEventListener('click', function(){ self.clearChartMarkers(); });
    var zoomIn = byId('chart-zoom-in'); if (zoomIn) zoomIn.addEventListener('click', function(){ self.chartManager.zoomIn(); });
    var zoomOut = byId('chart-zoom-out'); if (zoomOut) zoomOut.addEventListener('click', function(){ self.chartManager.zoomOut(); });
    var zoomReset = byId('chart-zoom-reset'); if (zoomReset) zoomReset.addEventListener('click', function(){ self.chartManager.resetZoom(); });

    var closeSettings = byId('close-settings-modal-btn'); if (closeSettings) closeSettings.addEventListener('click', function(){ self.closeSettingsModal(); });
    var settingsOverlay = byId('settings-modal-overlay'); if (settingsOverlay) settingsOverlay.addEventListener('click', function(e){ if (e.target.id==='settings-modal-overlay') self.closeSettingsModal(); });

    var setOn = function(id, handler){ var el=byId(id); if (el) el.addEventListener('change', handler); };
    var setOnInput = function(id, handler){ var el=byId(id); if (el) el.addEventListener('input', handler); };

    setOnInput('modal-confluence-threshold', function(e){ self.settings.confluenceThreshold = parseInt(e.target.value,10)||3; });
    setOn('modal-param-rsi-period', function(e){ self.settings.params.rsiPeriod = parseInt(e.target.value,10)||14; self.calculateAllIndicators(); });
    setOn('modal-param-atr-period', function(e){ self.settings.params.atrPeriod = parseInt(e.target.value,10)||14; self.calculateAllIndicators(); });
    setOn('modal-param-wall-btc', function(e){ self.settings.params.wallBtc = parseInt(e.target.value,10)||20; });
    setOn('modal-param-rr-ratio', function(e){ self.settings.params.rrRatio = parseFloat(e.target.value)||1.5; });

    setOn('modal-signal-cooldown-ms', function(e){ self.settings.cooldowns.signalMs = parseInt(e.target.value,10)||0; });
    setOn('modal-same-direction-cooldown-ms', function(e){ self.settings.cooldowns.sameDirectionMs = parseInt(e.target.value,10)||0; });
    setOn('modal-opposite-direction-cooldown-ms', function(e){ self.settings.cooldowns.oppositeDirectionMs = parseInt(e.target.value,10)||0; });
    setOn('modal-reverse-hysteresis-points', function(e){ self.settings.cooldowns.reverseHysteresisPoints = parseInt(e.target.value,10)||0; });
    setOn('modal-proposal-timeout-ms', function(e){ self.settings.cooldowns.proposalTimeoutMs = parseInt(e.target.value,10)||1000; });
    setOn('modal-strategy-proposal-cooldown-ms', function(e){ self.settings.cooldowns.strategyProposalMs = parseInt(e.target.value,10)||0; });

    var toggles = byId('modal-strategy-toggles'); if (toggles) toggles.addEventListener('change', function(e){
      if (e.target && e.target.classList && e.target.classList.contains('strategy-toggle')){
        var key = e.target.getAttribute('data-strategy-key');
        self.settings.activeStrategies[key] = e.target.checked;
        self.updateActiveStrategies();
        self.showNotification((self.strategies[key].displayName || key) + ' ' + (e.target.checked ? 'aktif' : 'pasif') + '.', 'info');
        self.saveSettings();
      }
    });

    var clearSignalsBtn = byId('modal-clear-signals-btn'); if (clearSignalsBtn) clearSignalsBtn.addEventListener('click', function(){ self.clearAllSignals(); });
    var resetAllBtn = byId('reset-all-settings-btn'); if (resetAllBtn) resetAllBtn.addEventListener('click', function(){ self.resetAllSettings(); });
    var saveSettingsBtn = byId('save-settings-btn'); if (saveSettingsBtn) saveSettingsBtn.addEventListener('click', function(){ self.saveSettings(); self.showNotification('Ayarlar kaydedildi!', 'success'); self.closeSettingsModal(); });

    // Şeref panosu
    var honorBtn = byId('honor-btn'); if (honorBtn) honorBtn.addEventListener('click', function(){ self.openBoardModal(); });
    var dishonorBtn = byId('dishonor-btn'); if (dishonorBtn) dishonorBtn.addEventListener('click', function(){ self.openBoardModal(); });
    var bannedBtn = byId('banned-btn'); if (bannedBtn) bannedBtn.addEventListener('click', function(){ self.openBoardModal(); });
    var closeBoardBtn = byId('close-board-modal-btn'); if (closeBoardBtn) closeBoardBtn.addEventListener('click', function(){ self.closeBoardModal(); });
    var boardOverlay = byId('board-modal-overlay'); if (boardOverlay) boardOverlay.addEventListener('click', function(e){ if (e.target.id==='board-modal-overlay') self.closeBoardModal(); });
  }

  toggleControlsPanel(){
    document.body.classList.toggle('header-collapsed');
    this.headerCollapsed = document.body.classList.contains('header-collapsed');
    setTimeout(function(){ window.dispatchEvent(new Event('resize')); },360);
  }
  switchMainView(viewName){
    this.currentMainView = viewName;
    var chartView = document.getElementById('chart-container-view');
    var heatmapView = document.getElementById('heatmap-container-view');
    if (!chartView || !heatmapView) return;
    if (viewName==='chart'){
      chartView.classList.remove('hidden-view'); heatmapView.classList.add('hidden-view');
      var self = this; setTimeout(function(){ if (self.chartManager && self.chartManager.chart) { self.chartManager.chart.resize(chartView.clientWidth, chartView.clientHeight); self.chartManager.chart.timeScale().fitContent(); } }, 0);
    } else {
      chartView.classList.add('hidden-view'); heatmapView.classList.remove('hidden-view');
      var self2 = this; setTimeout(function(){ if (self2.heatmapManager) self2.heatmapManager._resizeCanvas(); }, 0);
    }
  }

  openSettingsModal(){ this.updateSettingsModalUI(); var ov = document.getElementById('settings-modal-overlay'); if (ov) ov.classList.add('visible'); }
  closeSettingsModal(){ var ov = document.getElementById('settings-modal-overlay'); if (ov) ov.classList.remove('visible'); this.updateActiveStrategies(); this.calculateAllIndicators(); window.dispatchEvent(new Event('resize')); }

  openBoardModal(){ var ov = document.getElementById('board-modal-overlay'); if (ov) ov.classList.add('visible'); this.renderHonorBoards(); }
  closeBoardModal(){ var ov = document.getElementById('board-modal-overlay'); if (ov) ov.classList.remove('visible'); }

  resetAllSettings(){
    if (!confirm('Tüm ayarları ve sinyal geçmişini sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz.')) return;
    localStorage.removeItem('utc_settings');
    localStorage.removeItem('utc_signals');
    localStorage.removeItem('utc_stats');
    localStorage.removeItem('utc_strategy_stats');
    localStorage.removeItem('utc_ctx_stats');
    localStorage.removeItem('utc_shadow');
    localStorage.removeItem('utc_logit');
    localStorage.removeItem('utc_current_symbol');
    localStorage.removeItem('utc_current_timeframe');
    localStorage.removeItem('utc_header_collapsed');
    localStorage.removeItem('utc_current_view');

    this.settings = this.loadSettings();
    this.signals = [];
    this.stats = { total:0, tp:0, sl:0 };
    this.strategyStats = this.initDefaultStrategyStats();
    this.ctxStats = {};
    this.shadow = { byStrategy:{} };
    this.currentSymbol = 'BTCUSDT';
    this.currentTimeframe = '15m';
    this.headerCollapsed = true;
    this.currentMainView = 'chart';

    this.initStrategies();
    this.updateSettingsModalUI();
    this.renderSignals(true);
    this.renderStats(true);
    this.chartManager.clearMarkers();
    this.showNotification('Tüm ayarlar ve veriler sıfırlandı!', 'info');
    this.stop();
    document.body.classList.add('header-collapsed');
    this.switchMainView('chart');
  }

  async start(){
    if (this.isRunning) return;
    this.isRunning = true;
    var sb = document.getElementById('start-btn'); if (sb) sb.disabled = true;
    var stb = document.getElementById('stop-btn'); if (stb) stb.disabled = false;

    this.showNotification('Sistem Başlatıldı: Canlı veri akışı başlatılıyor...', 'success');
    await this.fetchInitialData();
    try{ await this.fetchHTFTrend('1h', 120); } catch(_){}
    this.connectWebSockets();
    var self=this;
    this.renderInterval = setInterval(function(){ self.render(); }, 250);
    this.analysisInterval = setInterval(function(){ self.runPeriodicAnalysis(); }, 5000);
    this.cooldownTuneInterval = setInterval(function(){ self.autoTuneCooldowns(); }, 60000);
    this.thresholdTuneInterval = setInterval(function(){ self.autoTuneThresholds(); }, 60000);
    this._paperTimer = setInterval(function(){ self.evaluatePaperProposals(); }, 30000);
    this._honorTimer = setInterval(function(){ self.renderHonorBoards(); }, 5000);
    this._htfTimer = setInterval(function(){ self.fetchHTFTrend('1h', 120).catch(function(){}); }, 120000);
  }
  stop(){
    if (!this.isRunning) return;
    this.isRunning = false;
    var sb = document.getElementById('start-btn'); if (sb) sb.disabled = false;
    var stb = document.getElementById('stop-btn'); if (stb) stb.disabled = true;
    this.disconnectWebSockets();
    if (this.renderInterval) clearInterval(this.renderInterval);
    if (this.analysisInterval) clearInterval(this.analysisInterval);
    if (this.cooldownTuneInterval) clearInterval(this.cooldownTuneInterval);
    if (this.thresholdTuneInterval) clearInterval(this.thresholdTuneInterval);
    if (this._paperTimer) clearInterval(this._paperTimer);
    if (this._honorTimer) clearInterval(this._honorTimer);
    if (this._htfTimer) clearInterval(this._htfTimer);
    this.updateConnectionStatus(false, 'BAĞLANTI KESİLDİ');
    if (this.combatModeActive) this.deactivateCombatMode();
    this.showNotification('Sistem Durduruldu.', 'danger');
  }

  async changeSymbol(newSymbol){
    if (this.currentSymbol===newSymbol) return;
    this.currentSymbol = newSymbol;
    this.showNotification(this.currentSymbol.replace('USDT','/USDT') + ' sembolüne geçildi.', 'info');
    this.resetDataForNewSymbol();
    this.updateSuperTopTicker();
    if (this.isRunning){ this.stop(); await this.start(); }
  }
  async changeTimeframe(newTimeframe){
    this.currentTimeframe = newTimeframe;
    this.showNotification('Zaman aralığı ' + this.currentTimeframe + ' olarak değiştirildi.', 'info');
    this.resetDataForNewSymbol();
    if (this.isRunning){ this.stop(); await this.start(); }
  }
  resetDataForNewSymbol(){
    this.candles=[]; this.aggTrades=[]; this.marketData={}; this.orderBook={ bids:[], asks:[], lastUpdateId:null };
    this.indicators={ rsi:[], atr:null, sma20:null, sma50:null, volSma20:null, vwap:null, adx:null };
    this.chartManager.setData([]); this.chartManager.clearMarkers(); this.render();
  }

  async fetchInitialData(){
    try{
      this.logToJournal(this.currentSymbol + ' için geçmiş mum verileri çekiliyor...');
      var url = 'https://fapi.binance.com/fapi/v1/klines?symbol=' + this.currentSymbol + '&interval=' + this.currentTimeframe + '&limit=500';
      var response = await fetch(url);
      if (!response.ok) throw new Error('API Hatası: ' + response.statusText);
      var data = await response.json();
      this.candles = data.map(function(d){ return { time:d[0], open:parseFloat(d[1]), high:parseFloat(d[2]), low:parseFloat(d[3]), close:parseFloat(d[4]), volume:parseFloat(d[5]) }; });
      this.chartManager.setData(this.candles);
      this.logToJournal(this.candles.length + ' adet mum yüklendi.');
      this.calculateAllIndicators();
    } catch(e){ this.showNotification('Geçmiş veri alınamadı: ' + e.message, 'danger'); console.error('Geçmiş veri hatası:', e); }
  }

  connectWebSockets(){
    this.disconnectWebSockets();
    this.reconnectAttempts=0;
    var symbolLower = this.currentSymbol.toLowerCase();
    var streams = [symbolLower+'@ticker', symbolLower+'@depth20@100ms', symbolLower+'@aggTrade', symbolLower+'@kline_'+this.currentTimeframe];
    var ws = new WebSocket('wss://fstream.binance.com/stream?streams=' + streams.join('/'));
    this.sockets.main = ws;
    var self = this;

    ws.onopen = function(){ self.updateConnectionStatus(true); self.reconnectAttempts=0; self.logToJournal('WebSocket bağlantısı başarıyla kuruldu.'); };
    ws.onmessage = function(event){ var message = JSON.parse(event.data); self.handleMarketData(message.stream, message.data); };
    ws.onerror = function(error){ console.error('WebSocket Hatası:', error); };
    ws.onclose = function(){
      if (self.isRunning){
        self.reconnectAttempts++;
        self.reconnectDelay = Math.min(30000, 3000 * Math.pow(2, self.reconnectAttempts-1));
        var message = 'YENİDEN BAĞLANILIYOR... (' + (self.reconnectDelay/1000) + 's)';
        self.updateConnectionStatus(false, message);
        self.logToJournal('Bağlantı kapandı. ' + (self.reconnectDelay/1000) + ' saniye sonra yeniden denenecek. (Deneme: ' + self.reconnectAttempts + ')');
        setTimeout(function(){ self.connectWebSockets(); }, self.reconnectDelay);
      }
    };
  }
  disconnectWebSockets(){ if (this.sockets.main){ try{ this.sockets.main.onclose = null; this.sockets.main.close(1000,'İstemci tarafından kapatıldı'); } catch(_){ } } }

  handleMarketData(stream, data){
    var streamType = (stream.split('@')[1] || '');
    if (streamType==='ticker'){
      this.marketData = { price: parseFloat(data.c), change24h: parseFloat(data.P), volume24h: parseFloat(data.q), symbol: data.s, btcPrice: (data.s==='BTCUSDT' ? parseFloat(data.c) : this.marketData.btcPrice) };
      this.manageOpenPositions();
      this.checkAutoCloseSignals();
    } else if (streamType.indexOf('depth')===0){
      this.orderBook = { bids: data.b.map(function(x){return [parseFloat(x[0]), parseFloat(x[1])];}), asks: data.a.map(function(x){return [parseFloat(x[0]), parseFloat(x[1])];}), lastUpdateId: data.u };
      this.heatmapManager.draw(this.orderBook, this.marketData.price);
      for (var k in this.activeStrategies){ if (this.activeStrategies.hasOwnProperty(k)) this.activeStrategies[k].analyzeOrderBook(this.orderBook); }
    } else if (streamType.indexOf('kline')===0){
      if (this.candles.length>0){
        var kline = data.k;
        this.chartManager.updateRealtime(kline);
        if (kline.x){
          var newCandle = { time:kline.t, open:parseFloat(kline.o), high:parseFloat(kline.h), low:parseFloat(kline.l), close:parseFloat(kline.c), volume:parseFloat(kline.v) };
          var lastCandle = this.candles[this.candles.length-1];
          if (lastCandle.time === kline.t) this.candles[this.candles.length-1] = newCandle; else this.candles.push(newCandle);
          if (this.candles.length>500) this.candles.shift();
          this.calculateAllIndicators();
        }
        this.manageOpenPositions();
        this.checkAutoCloseSignals();
      }
    } else if (streamType==='aggTrade'){
      var trade = { price: parseFloat(data.p), quantity: parseFloat(data.q), isBuyerMaker: data.m, timestamp: data.T };
      for (var k2 in this.activeStrategies){ if (this.activeStrategies.hasOwnProperty(k2) && typeof this.activeStrategies[k2].processTrade==='function') this.activeStrategies[k2].processTrade(trade); }
    }
  }

  runPeriodicAnalysis(){ if (!this.isRunning) return; for (var k in this.activeStrategies){ if (this.activeStrategies.hasOwnProperty(k)) this.activeStrategies[k].periodicAnalyze(); } }

  calculateAllIndicators(){
    var rsiPeriod = this.settings.params.rsiPeriod;
    var closes = this.candles.map(function(c){ return c.close; });
    if (closes.length < rsiPeriod) return;
    var avgGain=0, avgLoss=0;
    for (var i=1;i<=rsiPeriod;i++){ var diff = closes[i]-closes[i-1]; if (diff>0) avgGain += diff; else avgLoss -= diff; }
    avgGain/=rsiPeriod; avgLoss/=rsiPeriod;
    var rsi=[]; for (var z=0;z<rsiPeriod;z++) rsi.push(NaN);
    rsi.push(100 - (100 / (1 + (avgGain / (avgLoss||1e-8)))));
    for (var j=rsiPeriod+1;j<closes.length;j++){
      var df = closes[j]-closes[j-1];
      avgGain = (avgGain*(rsiPeriod-1) + (df>0?df:0))/rsiPeriod;
      avgLoss = (avgLoss*(rsiPeriod-1) + (df<0?-df:0))/rsiPeriod;
      rsi.push(100 - (100 / (1 + (avgGain / (avgLoss || 1e-8)))));
    }
    this.indicators.rsi = rsi;

    var atrPeriod = this.settings.params.atrPeriod;
    if (this.candles.length < atrPeriod) return;
    var trs=[];
    for (var t=1;t<this.candles.length;t++){
      var c = this.candles[t], p = this.candles[t-1];
      trs.push(Math.max(c.high-c.low, Math.abs(c.high-p.close), Math.abs(c.low-p.close)));
    }
    if (trs.length===0) return;
    var atrSum = trs.slice(0,atrPeriod).reduce((a,b)=>a+b,0);
    this.indicators.atr = atrSum/atrPeriod;

    var sma = function(arr,n){ var len=Math.min(arr.length,n); if (len<=0) return null; return arr.slice(-len).reduce((a,b)=>a+b,0)/len; };
    if (closes.length>=20) this.indicators.sma20 = sma(closes,20);
    if (closes.length>=50) this.indicators.sma50 = sma(closes,50);
    var volumes = this.candles.map(function(x){return x.volume;});
    if (volumes.length>=20) this.indicators.volSma20 = sma(volumes,20);
    var cumPV=0, cumV=0;
    for (var q=0;q<this.candles.length;q++){ var k = this.candles[q]; var tp = (k.high+k.low+k.close)/3; cumPV += tp*k.volume; cumV += k.volume; }
    this.indicators.vwap = cumV ? (cumPV/cumV) : null;

    this.indicators.adx = this.calcADX(this.candles, atrPeriod);
    this.marketRegime = (this.indicators.adx && this.indicators.adx > 22) ? 'trend' : 'range';
  }
  calcADX(candles, period){
    if (!candles || candles.length < period+2) return null;
    var tr=[], plusDM=[], minusDM=[];
    for (var i=1;i<candles.length;i++){
      var c=candles[i], p=candles[i-1];
      var upMove=c.high - p.high, downMove=p.low - c.low;
      var trueRange = Math.max(c.high-c.low, Math.abs(c.high - p.close), Math.abs(c.low - p.close));
      tr.push(trueRange);
      plusDM.push((upMove>downMove && upMove>0)?upMove:0);
      minusDM.push((downMove>upMove && downMove>0)?downMove:0);
    }
    var smooth = function(arr){
      var s = arr.slice(0,period).reduce((a,b)=>a+b,0);
      var out=[s]; for (var i=period;i<arr.length;i++){ s = s - (s/period) + arr[i]; out.push(s); } return out;
    };
    var trS = smooth(tr), pS = smooth(plusDM), mS = smooth(minusDM);
    var dxArr=[];
    var L = Math.min(trS.length, pS.length, mS.length);
    for (var i2=0;i2<L;i2++){
      var atr = trS[i2]/period;
      var pdi = 100 * ((pS[i2]/period)/Math.max(1e-8, atr));
      var mdi = 100 * ((mS[i2]/period)/Math.max(1e-8, atr));
      var dx = 100 * Math.abs(pdi - mdi) / Math.max(1, (pdi + mdi));
      dxArr.push(dx);
    }
    var last = dxArr.slice(-period);
    if (!last.length) return null;
    return last.reduce((a,b)=>a+b,0)/last.length;
  }

  getOrderBookSnapshotInfo(){
    var ob = this.orderBook;
    if (!ob || !ob.bids || !ob.asks || ob.bids.length===0 || ob.asks.length===0) return null;
    var bestBid = ob.bids[0][0], bestAsk = ob.asks[0][0];
    var mid = (bestAsk + bestBid)/2;
    var spreadPct = (bestAsk - bestBid)/mid;
    var topN = (this.settings.optimization.gating.topN || 5);
    var price = this.marketData.price || mid || 1;
    var sumUsd = function(levels){ return levels.slice(0,topN).reduce((s,v)=> s + (v[0]*v[1]), 0); };
    var topBidUsd = sumUsd(ob.bids);
    var topAskUsd = sumUsd(ob.asks);
    var minTopUsd = Math.min(topBidUsd, topAskUsd);
    return { bestBid, bestAsk, spreadPct, topBidUsd, topAskUsd, minTopUsd, mid, price };
  }
  marketGatingPenalty(){
    var info = this.getOrderBookSnapshotInfo();
    if (!info) return 0;
    var g = this.settings.optimization.gating;
    var penalty=0;
    if (info.spreadPct > g.spreadMaxPct) penalty += 1;
    if (info.minTopUsd < g.minDepthUsd) penalty += 1;
    return penalty;
  }

  async fetchHTFTrend(interval, len){
    var url = 'https://fapi.binance.com/fapi/v1/klines?symbol=' + this.currentSymbol + '&interval=' + interval + '&limit=' + len;
    var r = await fetch(url); var d = await r.json();
    var closes = d.map(function(x){ return parseFloat(x[4]); });
    var sma = function(arr,n){ var len=Math.min(arr.length,n); if (len<=0) return null; return arr.slice(-len).reduce((a,b)=>a+b,0)/len; };
    var sma20 = sma(closes,20), sma50 = sma(closes,50);
    var last = closes[closes.length-1] || 0;
    this.htfTrend = (last > sma50 && sma20 > sma50) ? 'up' : (last < sma50 && sma20 < sma50) ? 'down' : 'flat';
  }
  getHTFPenalty(direction){
    if (!this.htfTrend || this.htfTrend==='flat') return 0;
    if (direction==='buy' && this.htfTrend==='down') return 1;
    if (direction==='sell' && this.htfTrend==='up') return 1;
    return 0;
  }

  getEffectiveThreshold(){ return (this.settings.confluenceThreshold || 3) + (this.runtimeThresholdOffset || 0); }
  buildFeatures(buyObj, sellObj){
    var atrPct = (this.indicators.atr && this.marketData.price) ? (this.indicators.atr/this.marketData.price) : 0;
    var adx = this.indicators.adx || 0;
    var ob = this.getOrderBookSnapshotInfo() || {};
    var spread = ob.spreadPct || 0, depth = Math.min(3e5, ob.minTopUsd||0)/3e5;
    var dirDiff = (buyObj.score||0) - (sellObj.score||0);
    var top = function(o){ return (o && o.contributors ? o.contributors : []).map(function(c){return c.effScore||0;}).sort(function(a,b){return b-a;}).slice(0,3); };
    var topB = top(buyObj), topS = top(sellObj);
    return [
      dirDiff,
      buyObj.score||0, sellObj.score||0,
      (buyObj.groupSums && buyObj.groupSums.trending)||0, (buyObj.groupSums && buyObj.groupSums.meanReversion)||0,
      (sellObj.groupSums && sellObj.groupSums.trending)||0, (sellObj.groupSums && sellObj.groupSums.meanReversion)||0,
      atrPct, adx/100, spread, depth,
      topB[0]||0, topB[1]||0, topB[2]||0,
      topS[0]||0, topS[1]||0, topS[2]||0
    ];
  }

  calculateDynamicTpSl(signal){
    var atr = this.indicators.atr;
    var price = this.marketData.price || signal.price;
    var rrRatioBase = this.settings.params.rrRatio;
    var p = (this.classifier && signal.features) ? this.classifier.predict(signal.features) : (signal.prob || 0.55);
    var grpBias = (signal.reason || '').toLowerCase().indexOf('trend') !== -1 ? 1.15 : 1.0;
    var rr = Math.min(2.8, Math.max(1.1, rrRatioBase * (0.9 + p*0.6) * grpBias));
    if (this.riskState==='conservative') rr = Math.max(1.1, rr*0.9);
    if (this.riskState==='aggressive') rr = Math.min(3.0, rr*1.1);

    if (!atr || atr===0){
      signal.sl = signal.direction==='buy' ? price*0.995 : price*1.005;
      signal.tp = signal.direction==='buy' ? price*(1 + 0.01*rr) : price*(1 - 0.01*rr);
    } else {
      var atrMultiplier = Math.max(0.8, 1.6 - p);
      var slDistance = atr * atrMultiplier;
      var tpDistance = slDistance * rr;
      if (signal.direction==='buy'){ signal.sl = price - slDistance; signal.tp = price + tpDistance; }
      else { signal.sl = price + slDistance; signal.tp = price - tpDistance; }
      signal.entrySlDistance = slDistance; signal.entryTpDistance = tpDistance;
    }
  }

  manageOpenPositions(){
    var price = this.marketData.price; if (!price || this.signals.length===0) return;
    var settings = this.settings.optimization.breakeven || {}; if (!settings.enabled) return;
    var changed=false;
    var active = this.signals.filter(s => s.status==='active' && s.symbol===this.currentSymbol);
    for (var i=0;i<active.length;i++){
      var s = active[i];
      if (!s.entrySlDistance || s.entrySlDistance<=0) continue;
      var rNow = s.direction==='buy' ? (price - s.price)/s.entrySlDistance : (s.price - price)/s.entrySlDistance;
      s.mfeR = Math.max(s.mfeR || 0, rNow);
      if (!s.beDone && s.mfeR >= (settings.beAtR || 0.8)){ s.sl = s.price; s.beDone=true; s.note = (s.note||'') + ' | SL->BE'; changed=true; }
      if (s.mfeR >= (settings.trailAfterR || 1.5) && (s.trailingStage||0) < 1){
        var addR = (settings.trailToR || 0.5) * s.entrySlDistance;
        if (s.direction==='buy') s.sl = Math.min(s.tp, s.price + addR); else s.sl = Math.max(s.tp, s.price - addR);
        s.trailingStage = 1; s.note = (s.note||'') + ' | Trail1'; changed=true;
      }
    }
    if (changed) this.saveData('utc_signals', this.signals);
  }

  checkAutoCloseSignals(){
    var price = this.marketData.price; if (!price || this.signals.length===0) return;
    var active = this.signals.filter(s => s.status==='active' && s.symbol===this.currentSymbol);
    var now = Date.now();
    for (var i=0;i<active.length;i++){
      var s = active[i];
      if (s.direction==='buy'){
        if (price >= s.tp) this.updateSignalResult(s.id,'tp');
        else if (price <= s.sl) this.updateSignalResult(s.id,'sl');
      } else {
        if (price <= s.tp) this.updateSignalResult(s.id,'tp');
        else if (price >= s.sl) this.updateSignalResult(s.id,'sl');
      }
      if (s.entrySlDistance && (now - s.timestamp) > (this.settings.optimization.timeStopMs || 20*60*1000)){
        var rNow = s.direction==='buy' ? (price - s.price)/s.entrySlDistance : (s.price - price)/s.entrySlDistance;
        if ((s.mfeR||0) < 0.3 && rNow < 0.1) this.updateSignalResult(s.id,'sl');
      }
    }
  }

  render(){ this.renderPriceDisplay(); }
  renderPriceDisplay(){
    var priceEl = document.getElementById('current-price');
    var tickerPriceEl = document.getElementById('ticker-bar-price');
    var oldText = tickerPriceEl ? tickerPriceEl.textContent : '0';
    var oldPrice = this.marketData.price ? parseFloat((oldText||'0').replace(/,/g,'')) : 0;
    if (this.marketData.price){
      var formatted = this.formatPrice(this.marketData.price);
      if (priceEl) priceEl.textContent = formatted;
      if (tickerPriceEl) tickerPriceEl.textContent = formatted;
      if (!isNaN(oldPrice) && oldPrice!==0){
        var color = this.marketData.price > oldPrice ? 'var(--positive)' : (this.marketData.price < oldPrice ? 'var(--negative)' : '');
        if (color){ if (priceEl) priceEl.style.color = color; if (tickerPriceEl) tickerPriceEl.style.color = color; }
      }
    }
    var change = this.marketData.change24h || 0;
    var changeEl = document.getElementById('price-change-24h');
    if (changeEl){ changeEl.textContent = change.toFixed(2) + '%'; changeEl.style.color = change>=0 ? 'var(--positive)' : 'var(--negative)'; }
    var volumeEl = document.getElementById('volume-24h'); if (volumeEl) volumeEl.textContent = this.formatVolume(this.marketData.volume24h);
    var atrEl = document.getElementById('atr-value'); if (atrEl) atrEl.textContent = this.indicators.atr ? this.indicators.atr.toFixed(this.getDecimalPlaces(this.indicators.atr)) : '-';
  }

  addFinalSignal(signal){
    this.signals.unshift(signal); if (this.signals.length>200) this.signals.pop();
    this.saveData('utc_signals', this.signals);
    this.renderSignals(true);
    this.renderStats(true);
    this.chartManager.addSignalMarker(signal);
    this.showNotification('YENİ SİNYAL: ' + signal.direction.toUpperCase() + ' ' + signal.symbol.replace('USDT','/USDT') + ' | Skor: ' + (typeof signal.score==='number'?signal.score.toFixed(1):signal.score), signal.direction==='buy' ? 'success' : 'danger');
    playSignal(signal.direction);
    if (signal.score >= 8) this.activateCombatMode();
  }

  updateSignalResult(signalId, result){
    var s = this.signals.find(function(x){return x.id===signalId;});
    if (s && s.status==='active'){
      s.status = result;
      this.stats.total++; this.stats[result] = (this.stats[result]||0) + 1;
      this.updateStrategyStats(s);
      var y = (s.status==='tp') ? 1 : 0;
      if (s.features) this.classifier.update(y, s.features);

      this.saveData('utc_signals', this.signals);
      this.saveData('utc_stats', this.stats);
      this.renderSignals(true);
      this.renderStats(true);
      this.showNotification('Sinyal ' + result.toUpperCase() + ' olarak işaretlendi.', 'info');
    }
  }

  updateStrategyStats(signal){
    var isWin = signal.status==='tp';
    var contributors = signal.contributors || [];
    var totalEff = contributors.reduce(function(s,c){ return s + (c.effScore || ((c.baseScore||0) * (c.weight||1))); }, 0) || 1;
    var decay = 0.995;
    var ctxKey = this.getContextKey();

    for (var i=0;i<contributors.length;i++){
      var c = contributors[i];
      var credit = (c.effScore || ((c.baseScore||0) * (c.weight||1))) / totalEff;

      var stat = this.strategyStats[c.strategy] || { alpha:3, beta:2, proposals:0, contrib:0, wins:0, losses:0, lastUpdate: Date.now() };
      stat.alpha *= decay; stat.beta *= decay;
      if (isWin){ stat.wins += credit; stat.alpha += credit; } else { stat.losses += credit; stat.beta += credit; }
      stat.contrib += 1; stat.lastUpdate = Date.now();
      this.strategyStats[c.strategy] = stat;

      this.ctxStats[c.strategy] = this.ctxStats[c.strategy] || {};
      var cs = this.ctxStats[c.strategy][ctxKey] || { alpha:2, beta:2, contrib:0, wins:0, losses:0 };
      cs.alpha *= decay; cs.beta *= decay;
      if (isWin){ cs.wins += credit; cs.alpha += credit; } else { cs.losses += credit; cs.beta += credit; }
      cs.contrib += 1;
      this.ctxStats[c.strategy][ctxKey] = cs;
    }

    // proposal cooldown adapt
    for (var k in this.activeStrategies){
      var w = this.getStrategyWeight(k);
      var base = this.settings.cooldowns.strategyProposalMs || 10000;
      var factor = Math.max(0.5, Math.min(2.0, 1.2/Math.max(0.01,w)));
      var newCd = Math.max(500, Math.round(base*factor));
      this.strategies[k].DEFAULT_PROPOSAL_COOLDOWN_MS = newCd;
    }
    // hızlı shadow tetikleyici
    for (var i2=0;i2<contributors.length;i2++){
      var w2 = this.getStrategyWeight(contributors[i2].strategy);
      if (w2 < 0.5) this.shadowBan(contributors[i2].strategy, 'rapid decay w=' + w2.toFixed(2));
    }

    this.saveStrategyStats(); this.saveCtxStats();
    this.renderHonorBoards();
  }

  autoToggleStrategies(){
    if (!this.settings.optimization.autoToggle) return;
    var now = Date.now();
    if (now - this.lastAutoToggleTs < 15*60*1000) return;
    this.lastAutoToggleTs = now;
    var minW = this.settings.optimization.minWeightToStay || 0.6;
    var minContrib = this.settings.optimization.minContribForToggle || 30;

    for (var i=0;i<this.allStrategyKeys.length;i++){
      var key = this.allStrategyKeys[i];
      var w = this.getStrategyWeight(key);
      var stat = this.strategyStats[key] || {};
      var active = !!this.settings.activeStrategies[key];
      if (active && w < minW && (stat.contrib||0) >= minContrib){
        this.shadowBan(key, 'low weight w=' + w.toFixed(2), this.shadowConfig.banDurMs);
      } else {
        if (this.isShadowed(key) && w >= 1.0) this.liftShadow(key, 'weight ' + w.toFixed(2));
      }
    }
    this.updateActiveStrategies(); this.saveSettings();
  }

  autoTuneCooldowns(){
    if (!this.isRunning) return;
    var now = Date.now(), WINDOW_MS = 5*60*1000;
    var recent = this.signals.filter(s => now - s.timestamp <= WINDOW_MS).slice(0,100).sort(function(a,b){return a.timestamp-b.timestamp;});
    var quickFlips=0, totalPairs=0;
    for (var i=1;i<recent.length;i++){ totalPairs++; var dt = recent[i].timestamp - recent[i-1].timestamp; if (recent[i-1].direction !== recent[i].direction && dt<=15000) quickFlips++; }
    var flipRatio = totalPairs ? (quickFlips/totalPairs) : 0;
    var volPct = (this.indicators.atr && this.marketData.price) ? (this.indicators.atr/this.marketData.price) : 0.001;

    var cd = this.settings.cooldowns;
    var baseSame = cd.sameDirectionMs || 30000;
    var baseOpp = cd.oppositeDirectionMs || 20000;
    var baseSignal = cd.signalMs || 15000;

    var newSame = Math.max(10000, Math.min(120000, Math.round(baseSame*(1 + flipRatio*0.8))));
    var newOpp = Math.max(5000, Math.min(120000, Math.round(baseOpp*(1 + flipRatio*1.2))));
    var volFactor = volPct < 0.005 ? 0.8 : (volPct > 0.02 ? 1.3 : 1.0);
    var newSignal = Math.max(3000, Math.min(60000, Math.round(baseSignal*volFactor)));
    var newProposalTimeout = Math.max(1500, Math.min(8000, Math.round(2000 + 6000*volPct)));

    var changed = Math.abs(newSame-baseSame)/baseSame>0.1 || Math.abs(newOpp-baseOpp)/baseOpp>0.1 || Math.abs(newSignal-baseSignal)/baseSignal>0.1 || Math.abs(newProposalTimeout-cd.proposalTimeoutMs)/Math.max(1,cd.proposalTimeoutMs)>0.1;
    if (changed){
      this.settings.cooldowns.sameDirectionMs = newSame;
      this.settings.cooldowns.oppositeDirectionMs = newOpp;
      this.settings.cooldowns.signalMs = newSignal;
      this.settings.cooldowns.proposalTimeoutMs = newProposalTimeout;
      this.saveSettings();
      this.showNotification('Cooldown optimize (flip: ' + Math.round(flipRatio*100) + '%, vol: ' + (volPct*100).toFixed(2) + '%).', 'warning');
    }
    this.autoToggleStrategies();
  }

  autoTuneThresholds(){
    if (!this.isRunning) return;
    var windowSignals = this.signals.filter(s => s.symbol===this.currentSymbol).slice(0,40);
    var recent = windowSignals.slice(0,20);
    var tp = recent.filter(s => s.status==='tp').length;
    var sl = recent.filter(s => s.status==='sl').length;
    var winRate = (tp+sl)>0 ? tp/(tp+sl) : 0.5;

    var quickFlips=0, pairs=0;
    var ordered = recent.slice().sort(function(a,b){return a.timestamp-b.timestamp;});
    for (var i=1;i<ordered.length;i++){ pairs++; if (ordered[i-1].direction !== ordered[i].direction && (ordered[i].timestamp - ordered[i-1].timestamp) <= 15000) quickFlips++; }
    var flipRatio = pairs ? quickFlips/pairs : 0;

    var targetOffset = 0;
    if (winRate <= 0.4 || flipRatio > 0.25) targetOffset = 1;
    if (winRate <= 0.3) targetOffset = 2;
    if (winRate >= 0.6 && flipRatio < 0.1) targetOffset = 0;

    if (winRate <= 0.35) this.riskState = 'conservative';
    else if (winRate >= 0.65) this.riskState = 'aggressive';
    else this.riskState = 'neutral';

    this.runtimeThresholdOffset = 0.7*(this.runtimeThresholdOffset||0) + 0.3*targetOffset;
  }

  /* Shadow helpers */
  isShadowed(name){
    var s = (this.shadow && this.shadow.byStrategy && this.shadow.byStrategy[name]) || null;
    if (!s) return false;
    if (s.until && Date.now() > s.until){ delete this.shadow.byStrategy[name]; this.saveData('utc_shadow', this.shadow); return false; }
    return !!s.active;
  }
  shadowBan(name, reason, durMs){
    var until = Date.now() + (durMs || this.shadowConfig.banDurMs);
    this.shadow.byStrategy[name] = { active:true, since:Date.now(), until:until, reason:reason||'low performance', paper:{ wins:0, losses:0, last:[] } };
    this.saveData('utc_shadow', this.shadow);
    this.showNotification((this.strategies[name] ? this.strategies[name].displayName : name) + ' shadowban: ' + (reason||''), 'warning');
  }
  liftShadow(name, why){
    if (this.shadow.byStrategy[name]){ delete this.shadow.byStrategy[name]; this.saveData('utc_shadow', this.shadow); this.showNotification((this.strategies[name]?this.strategies[name].displayName:name) + ' shadowban kaldırıldı (' + (why||'') + ').', 'success'); }
  }
  recordPaperProposal(strategy, direction, price){
    var atr = this.indicators.atr || (price*0.005);
    var dist = Math.max(atr * (this.shadowConfig.paperR||0.5), price*0.002);
    var tp = direction==='buy' ? price + dist : price - dist;
    var sl = direction==='buy' ? price - dist : price + dist;
    this.paperEval.queue.push({ strategy, direction, price, tp, sl, t0:Date.now(), evaluated:false });
    if (this.paperEval.queue.length>500) this.paperEval.queue.shift();
  }
  evaluatePaperProposals(){
    var now = Date.now();
    var c = this.candles || []; if (!c.length) return;
    var lookMs = this.shadowConfig.lookaheadMs;
    for (var i=0;i<this.paperEval.queue.length;i++){
      var p = this.paperEval.queue[i];
      if (p.evaluated || (now - p.t0) < lookMs) continue;
      var seg = c.filter(function(k){ return k.time >= p.t0; });
      if (!seg.length) { p.evaluated=true; continue; }
      var maxH = Math.max.apply(null, seg.map(function(k){return k.high;}));
      var minL = Math.min.apply(null, seg.map(function(k){return k.low;}));
      var win=false, loss=false;
      if (p.direction==='buy'){ win = maxH >= p.tp; loss = minL <= p.sl; }
      else { win = minL <= p.tp; loss = maxH >= p.sl; }

      var sb = this.shadow.byStrategy[p.strategy];
      if (sb){
        var paper = sb.paper || (sb.paper = { wins:0, losses:0, last:[] });
        if (win && !loss){ paper.wins += 1; paper.last.push(1); }
        else if (loss && !win){ paper.losses += 1; paper.last.push(0); }
        else { paper.losses += 0.5; paper.last.push(0); }
        var W = this.shadowConfig.probationWindow||8;
        while (paper.last.length > W) paper.last.shift();
        var winsInWindow = paper.last.reduce(function(a,b){return a+b;},0);
        if (paper.last.length>=W && winsInWindow >= (this.shadowConfig.probationWinsNeeded||4)){
          this.liftShadow(p.strategy, 'paper ' + winsInWindow + '/' + paper.last.length);
        }
        this.saveData('utc_shadow', this.shadow);
      }
      p.evaluated = true;
    }
  }

  /* Şeref Panosu */
  getStratMetrics(key){
    var s = this.strategyStats[key] || { wins:0, losses:0, contrib:0 };
    var wins = s.wins||0, losses = s.losses||0;
    var total = wins + losses;
    var wr = total>0 ? wins/total : NaN;
    var w = this.getStrategyWeight(key);
    var banned = this.isShadowed(key);
    return { key:key, display:(this.strategies[key] && this.strategies[key].displayName) || key, w:w, wr:wr, contrib:s.contrib||0, banned:banned };
  }
  classifyStrategies(){
    var honor=[], dishonor=[], banned=[];
    var minContrib=20;
    for (var i=0;i<this.allStrategyKeys.length;i++){
      var k = this.allStrategyKeys[i];
      var m = this.getStratMetrics(k);
      if (m.banned){ banned.push(m); continue; }
      if (m.contrib >= minContrib){
        if (m.w >= 1.0 && (!isNaN(m.wr) && m.wr >= 0.55)) honor.push(m);
        else if (m.w < 0.6 || (!isNaN(m.wr) && m.wr <= 0.45)) dishonor.push(m);
      }
    }
    honor.sort(function(a,b){ return b.w - a.w; });
    dishonor.sort(function(a,b){ return b.w - a.w; });
    banned.sort(function(a,b){ return a.display.localeCompare(b.display); });
    return { honor:honor, dishonor:dishonor, banned:banned };
  }
  renderBoardTable(arr, kind){
    if (!arr || !arr.length) return '<div style="padding:8px;color:var(--text-secondary)">Kayıt yok.</div>';
    var head = '<table class="data-table"><thead><tr><th>Strateji</th><th>w</th><th>WR</th><th>Contrib</th></tr></thead><tbody>';
    var rows = arr.map(function(m){
      var w = isFinite(m.w) ? m.w.toFixed(2) : '-';
      var wr = isFinite(m.wr) ? Math.round(m.wr*100) + '%' : '-';
      var color = kind==='honor' ? 'var(--positive)' : (kind==='dishonor' ? 'var(--negative)' : 'var(--text-main)');
      return '<tr><td>' + m.display + '</td><td style="color:' + color + '">' + w + '</td><td>' + wr + '</td><td>' + (m.contrib||0) + '</td></tr>';
    }).join('');
    return head + rows + '</tbody></table>';
  }
  renderHonorBoards(){
    var cls = this.classifyStrategies();
    var honorEl = document.getElementById('honor-list');
    var dishEl = document.getElementById('dishonor-list');
    var banEl = document.getElementById('banned-list');
    if (honorEl) honorEl.innerHTML = this.renderBoardTable(cls.honor, 'honor');
    if (dishEl) dishEl.innerHTML = this.renderBoardTable(cls.dishonor, 'dishonor');
    if (banEl) banEl.innerHTML = this.renderBoardTable(cls.banned, 'banned');
  }

  /* UI utils */
  formatContributors(signal, detailed){
    var cons = (signal && signal.contributors) ? signal.contributors : [];
    if (!cons.length) return '-';
    var parts = cons.map(c => {
      var name = (this.strategies[c.strategy] && this.strategies[c.strategy].displayName) || c.strategy;
      var raw = c.effScore || ((c.baseScore||0) * (c.weight||1));
      return { name:name, raw:raw, weight:(c.weight||1), baseScore:(c.baseScore||0) };
    });
    var total = parts.reduce(function(s,x){return s+x.raw;},0) || 1;
    for (var i=0;i<parts.length;i++){ parts[i].pct = Math.round((parts[i].raw/total)*100); }
    parts.sort(function(a,b){return b.pct - a.pct;});
    if (!detailed){
      var top = parts.slice(0,3).map(function(p){ return p.name + ' ' + p.pct + '%'; });
      var more = parts.length>3 ? ' +' + (parts.length-3) : '';
      return top.join(' | ') + more;
    } else {
      return parts.map(function(p){ return p.name + ': ' + p.pct + '% • w=' + p.weight.toFixed(2) + ' • s=' + p.baseScore; }).join(' | ');
    }
  }
  renderSignals(isModal){
    var tbody = isModal ? document.getElementById('modal-signals-body') : document.getElementById('signals-body');
    if (!tbody) return;
    var rows = (this.signals || []).map(s => {
      var t = new Date(s.timestamp).toLocaleTimeString();
      var dir = (s.direction || '').toUpperCase();
      var price = this.formatPrice(s.price);
      var tp = this.formatPrice(s.tp);
      var sl = this.formatPrice(s.sl);
      var score = (typeof s.score==='number') ? s.score.toFixed(1) : (s.score||'-');
      var contribShort = this.formatContributors(s, false);
      var contribFull = this.formatContributors(s, true);
      var status = (s.status||'ACTIVE').toUpperCase();
      var cls = s.status==='active' ? s.direction : s.status;
      return '<tr class="signal-' + cls + '"><td>' + t + '</td><td>' + dir + '</td><td>' + price + '</td><td>' + tp + '</td><td>' + sl + '</td><td>' + score + '</td><td title="' + contribFull + '">' + contribShort + '</td><td>' + status + '</td></tr>';
    }).join('');
    tbody.innerHTML = rows;
  }
  renderStats(isModal){
    var container = isModal ? document.getElementById('modal-stats-container') : document.getElementById('stats-container');
    if (!container) return;
    var total = (this.stats && this.stats.total) || 0;
    var tp = (this.stats && this.stats.tp) || 0;
    var sl = (this.stats && this.stats.sl) || 0;
    var wr = total>0 ? (tp/total*100).toFixed(1) : 'N/A';
    var regime = (this.marketRegime||'unknown').toUpperCase();
    var effThr = (this.getEffectiveThreshold ? this.getEffectiveThreshold().toFixed(1) : (this.settings.confluenceThreshold||3));
    container.innerHTML =
      '<div class="stat-item"><span class="stat-label">Toplam Sinyal:</span><span class="stat-value">' + total + '</span></div>' +
      '<div class="stat-item"><span class="stat-label">Başarılı (TP):</span><span class="stat-value" style="color:var(--positive)">' + tp + '</span></div>' +
      '<div class="stat-item"><span class="stat-label">Başarısız (SL):</span><span class="stat-value" style="color:var(--negative)">' + sl + '</span></div>' +
      '<div class="stat-item"><span class="stat-label">Başarı Oranı:</span><span class="stat-value" style="color:var(--primary)">' + wr + '%</span></div>' +
      '<div class="stat-item"><span class="stat-label">Rejim:</span><span class="stat-value">' + regime + '</span></div>' +
      '<div class="stat-item"><span class="stat-label">Efektif Eşik:</span><span class="stat-value">' + effThr + '</span></div>' +
      '<div class="stat-item"><span class="stat-label">Risk Durumu:</span><span class="stat-value">' + (this.riskState||'neutral') + '</span></div>';
    if (typeof this.renderHonorBoards==='function') this.renderHonorBoards();
  }

  activateCombatMode(){
    if (this.combatModeActive) return; this.combatModeActive=true; document.documentElement.setAttribute('data-theme','war');
    this.chartManager.updateTheme(); this.heatmapManager.updateTheme(); playSignal('combat'); this.showNotification('!!! SAVAŞ MODU AKTİF !!!', 'warning');
  }
  deactivateCombatMode(){
    this.combatModeActive=false; var savedTheme = localStorage.getItem('utc_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme); this.chartManager.updateTheme(); this.heatmapManager.updateTheme();
  }

  formatPrice(price){ if (price===undefined || price===null) return '-'; var d=this.getDecimalPlaces(price); return price.toLocaleString('en-US', { minimumFractionDigits:d, maximumFractionDigits:d }); }
  getDecimalPlaces(price){ if(price===undefined || price===null) return 2; if (price>1000) return 2; if (price>1) return 3; if (price>0.01) return 4; return 6; }
  formatVolume(volume){ if(!volume) return '-'; if (volume>=1e9) return (volume/1e9).toFixed(2)+'B'; if (volume>=1e6) return (volume/1e6).toFixed(2)+'M'; if (volume>=1e3) return (volume/1e3).toFixed(1)+'K'; return volume.toFixed(0); }
  toggleTheme(){
    if (this.combatModeActive){ this.deactivateCombatMode(); return; }
    var ct = document.documentElement.getAttribute('data-theme');
    var nt = (ct==='dark') ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', nt);
    localStorage.setItem('utc_theme', nt);
    this.chartManager.updateTheme(); this.heatmapManager.updateTheme();
  }

  updateConnectionStatus(isConnected, message){
    var sd = document.getElementById('connection-status'); var st = document.getElementById('connection-text'); var ts = document.getElementById('ticker-bar-symbol');
    if (isConnected){ if (sd) sd.classList.add('online'); if (st) st.textContent = 'BAĞLI (' + this.currentSymbol.replace('USDT','/USDT') + ')'; if (ts) ts.textContent = this.currentSymbol.replace('USDT','/USDT'); }
    else { if (sd) sd.classList.remove('online'); if (st) st.textContent = message || 'BAĞLANTI YOK'; }
  }
  showNotification(message, type){ var c=document.getElementById('notifications-container'); if(!c) return; var n=document.createElement('div'); n.className='notification ' + (type||'info'); n.textContent=message; c.prepend(n); setTimeout(function(){ n.style.transition='opacity 0.5s ease'; n.style.opacity=0; setTimeout(function(){ if(n && n.parentNode) n.parentNode.removeChild(n); },500); },5000); }
  logToJournal(msg){ console.log('[LOG] ' + new Date().toLocaleTimeString() + ' - ' + msg); }

  saveSettings(){ localStorage.setItem('utc_settings', JSON.stringify(this.settings)); }
  loadSettings(){
    var defaultActive = {}; for (var i=0;i<this.allStrategyKeys.length;i++) defaultActive[this.allStrategyKeys[i]] = (i<5);
    var defaults = {
      confluenceThreshold: 3,
      params: { rsiPeriod:14, atrPeriod:14, wallBtc:20, rrRatio:1.5 },
      cooldowns: { signalMs:15000, sameDirectionMs:30000, proposalTimeoutMs:3000, strategyProposalMs:10000, oppositeDirectionMs:20000, reverseHysteresisPoints:2 },
      optimization: { enabled:true, timeDecaySec:3, dirMargin:0.5, gating:{ spreadMaxPct:0.0015, minDepthUsd:50000, topN:5 }, breakeven:{ enabled:true, beAtR:0.8, trailAfterR:1.5, trailToR:0.5 }, autoToggle:true, minWeightToStay:0.6, minContribForToggle:30, probThreshold:0.55, timeStopMs:20*60*1000 },
      activeStrategies: defaultActive
    };
    var saved = this.loadData('utc_settings');
    if (saved){
      return {
        confluenceThreshold: saved.confluenceThreshold || defaults.confluenceThreshold,
        params: Object.assign({}, defaults.params, saved.params||{}),
        cooldowns: Object.assign({}, defaults.cooldowns, saved.cooldowns||{}),
        optimization: Object.assign({}, defaults.optimization, saved.optimization||{}),
        activeStrategies: Object.assign({}, defaults.activeStrategies, saved.activeStrategies||{})
      };
    }
    return defaults;
  }
  saveData(key,data){ try{ localStorage.setItem(key, JSON.stringify(data)); } catch(e){ console.error('Veri kaydedilemedi:', e); } }
  loadData(key){ try{ var data=localStorage.getItem(key); return data ? JSON.parse(data) : null; } catch(e){ console.error('Veri okunamadı:', e); return null; } }

  openBoardIfVisible(){ /* no-op placeholder */ }
  clearChartMarkers(){ if (this.chartManager) this.chartManager.clearMarkers(); }
  clearAllSignals(){
    if (!confirm('Tüm sinyalleri silmek istediğine emin misin?')) return;
    this.signals=[]; localStorage.removeItem('utc_signals'); this.renderSignals(true); this.chartManager.clearMarkers();
    this.stats = { total:0, tp:0, sl:0 }; this.saveData('utc_stats', this.stats); this.renderStats(true);
  }
}

document.addEventListener('DOMContentLoaded', function(){
  try {
    window.app = new UltimateTradingCommandCenter();
    setTimeout(function(){ window.dispatchEvent(new Event('resize')); }, 100);
  } catch(e){
    console.error('Uygulama başlatılırken kritik bir hata oluştu:', e);
    document.body.innerHTML = '<div style="color: red; padding: 20px; font-family: monospace;">Uygulama başlatılamadı. Konsolu kontrol edin. Hata: ' + e.message + '</div>';
  }
});
</script>
</body>
</html>